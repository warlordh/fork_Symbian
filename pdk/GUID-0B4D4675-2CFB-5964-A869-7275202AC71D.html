<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="task"/>
<meta name="DC.Title" content="Implement a subclass of CPositioner"/>
<meta name="abstract" content="This section describes the coding tasks necessary to implement a PSY."/>
<meta name="description" content="This section describes the coding tasks necessary to implement a PSY."/>
<meta name="DC.Relation" scheme="URI" content="GUID-CEBAC67F-DEFE-51EF-93CE-2FA61AA68997.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-7F476137-5E7F-5288-9F4A-6C20F0A1AD9B.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-F221FB14-8A28-5E84-AC5B-45C3C824A884.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-85DD1F91-2430-5C86-A13A-8360DDCC4A2F.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-CEBAC67F-DEFE-51EF-93CE-2FA61AA68997.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-86AD79A5-E18D-56C6-997A-5E2B24FEE80D.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Implement a subclass of CPositioner</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2402590 id2403330 id2403344 id2403358 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-7F476137-5E7F-5288-9F4A-6C20F0A1AD9B.html">Location Based Services (LBS) Guide</a> &gt; <a href="GUID-F221FB14-8A28-5E84-AC5B-45C3C824A884.html" title="The Data Source Adaptation collection contains an API and a test component used to create Positioning Module Plug-ins (PSYs).">Data Source Adaptation</a> &gt; <a href="GUID-85DD1F91-2430-5C86-A13A-8360DDCC4A2F.html" title="GPS Data Source Adaptation defines the Positioning Plug-in (PSY) API that allows device creators to develop Positioning Modules. It also contains a PSY test program that is used to test PSYs.">GPS Data Source Adaptation</a> &gt; <a href="GUID-CEBAC67F-DEFE-51EF-93CE-2FA61AA68997.html" title="The documents in this section describe how to use the Positioning Plug-In API to create a Positioning Plug-In.">Positioning Plug-In (PSY) Tutorial</a> &gt; </div>
<h1 class="topictitle1">Implement a subclass of CPositioner</h1>
<div><p>This section describes the coding tasks necessary to implement a PSY. </p>
<div class="section"><p> <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html"><span class="apiname">CPositioner</span></a> is the interface between the Location Framework and a PSY. A PSY must implement a <samp class="codeph">CPositioner</samp> subclass to handle positioning requests from the Location Framework. The Location Framework uses the PSY <samp class="codeph">CPositioner</samp> subclass object to handle the use cases of the Positioning Plug-in API. </p>
 <p>The use cases of the Positioning Plug-in API are as follows: </p>
 <ul><li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-4933506B-31B9-5D44-BF73-C7CA95495009"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-4933506B-31B9-5D44-BF73-C7CA95495009"><!-- --></a><p>The Location Framework loads the PSY either directly of via a Proxy PSY. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E1F338F7-F330-5401-9EE2-0AAF213B6D2F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E1F338F7-F330-5401-9EE2-0AAF213B6D2F"><!-- --></a><p>The Location Server sets update options on the PSY. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-2EC6EEF3-A214-5CC6-B3D5-11C456DE0171"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-2EC6EEF3-A214-5CC6-B3D5-11C456DE0171"><!-- --></a><p>The Location Server requests a position update. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-FFA81271-B344-5815-A23B-6ED96291B15B"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-FFA81271-B344-5815-A23B-6ED96291B15B"><!-- --></a><p>The Location Server requests periodic position updates. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-358F91F2-6015-5DF7-B040-EF5D843285B4"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-358F91F2-6015-5DF7-B040-EF5D843285B4"><!-- --></a><p>The Location Server cancels a location request. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-FD3CDD6D-CCE3-519B-B7F3-41467568A91B"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-FD3CDD6D-CCE3-519B-B7F3-41467568A91B"><!-- --></a><p>The PSY reports its status to the Location Server. </p>
 </li>
 </ul>
 </div>
 <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-DE141BC8-A365-5635-8EE0-DC901945B1A1"><!-- --></a><ol id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-DE141BC8-A365-5635-8EE0-DC901945B1A1"><li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-ED65A686-A47C-5E5C-AE83-1A1BAE6397D4"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-ED65A686-A47C-5E5C-AE83-1A1BAE6397D4"><!-- --></a><span>Create a sub-class of CPositioner </span>  The <a href="GUID-893737B2-4863-5BB9-8AA1-6AB5045FADC9.html">Positioning Module API</a> describes the classes of the API.   A PSY must implement the two overloaded <samp class="codeph">NewL()</samp> methods of the API to allow it to be loaded by the Location Framework or by a Proxy PSY. The two cases are described in more detail as follows:  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-23A99F1B-077B-5612-98A4-4351EA460CA8"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-23A99F1B-077B-5612-98A4-4351EA460CA8"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-CEE0F0D6-C6C4-5D42-998D-BD6EDC2C5772"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-CEE0F0D6-C6C4-5D42-998D-BD6EDC2C5772"><!-- --></a><span/><br/> Location Framework loads the PSY   When the Location Framework loads a PSY it instantiates an instance of the <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html"><span class="apiname">CPositioner</span></a> subclass using the <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-D9F3B20A-A6EC-366B-9457-E92B9F9B4C60"><span class="apiname">CPositioner::NewL()</span></a> method. The subclass implementation must define a <samp class="codeph">NewL</samp> (<samp class="codeph">TAny* aConstructionParameters</samp>) constructor.   This constructor must call <samp class="codeph">CPositioner::BaseConstructL</samp> (<samp class="codeph">TAny*
                     aConstructionParameters</samp>) first after the instance has been created. The construction parameters received in <samp class="codeph">NewL()</samp> must be forwarded to BaseConstructL(). It is not permitted to pass a NULL pointer. The pointer is used for the internal construction of the <samp class="codeph">CPositioner</samp> instance.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8C30DA5F-1E52-534C-9CBF-2E4E326CF067"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8C30DA5F-1E52-534C-9CBF-2E4E326CF067"><!-- --></a><span/><br/> A Proxy PSY loads the PSY   A Proxy PSY (such as the Default Proxy PSY) can instantiate other PSYs. When the Proxy PSY instantiates a PSY it must use the overloaded static constructor <samp class="codeph">NewL(TUid aImplementationUid, const CPositioner&amp;
                     aPositioner)</samp> where <samp class="codeph">aImplementationUid</samp> is the UID of the PSY that must be constructed and the <samp class="codeph">CPositioner</samp> parameter is the Proxy PSY instance.   The constructor parameters for the PSY are derived from the Proxy PSY instance in this case. A Proxy PSY must not use the constructor used by the Location Framework since the construction parameters are not public.   A PSY must also report the device status when it is loaded and unloaded.  </li>
 </ol>
  The following code example shows an example PSY static constructor implementation.   <pre class="codeblock" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-08683B8A-0BAC-5190-862D-A67013E0041F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-08683B8A-0BAC-5190-862D-A67013E0041F"><!-- --></a>CPosExamplePositioner* CPosExamplePositioner::NewL(
    TAny* aConstructionParameters)
    {
    CPosExamplePositioner* self =
        new (ELeave) CPosExamplePositioner;

    CleanupStack::PushL(self);
    self-&gt;ConstructL(aConstructionParameters);
    CleanupStack::Pop();

    return self;
    }

void CPosExamplePositioner::ConstructL(
    TAny* aConstructionParameters)
    {
    // Must call BaseConstructL first thing during
    // construction.
    BaseConstructL(aConstructionParameters);
    }
</pre>
  </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-82CD3F69-85A8-5D9D-9C38-9F4424A33B4A"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-82CD3F69-85A8-5D9D-9C38-9F4424A33B4A"><!-- --></a><span>Write code to handle the Location Server setting GPS options </span>  The PSY can also be passed options for a position request. The parameters are obtained through accessor methods provided on the <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html"><span class="apiname">CPositioner</span></a> class.   The <samp class="codeph">CPositioner</samp> base class provides a default implementation that retrieves the options provided by the client application when it makes a location request. The PSY implementation can override these methods if required:  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F357104A-BE9B-5919-8AB6-15114BF7DC17"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F357104A-BE9B-5919-8AB6-15114BF7DC17"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-D91E3CAB-29D6-5CBE-912A-CBAF4A54F83C"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-D91E3CAB-29D6-5CBE-912A-CBAF4A54F83C"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-F72BE40F-537B-3633-B6BF-65B694682681"><span class="apiname">CPositioner::GetMaxAge()</span></a>    A client application may specify a maximum age when performing a position request. This means that a position can be returned from an old measurement as long as the position is not older than the specified maximum age. Supporting maximum age is optional in a PSY. If the PSY developer wants to support the maximum age, the PSY must be implemented to cache the latest position estimate. <samp class="codeph">GetMaxAge()</samp> is the function that the PSY implementation can use to retrieve the maximum age specified by the client.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-EFB2A64D-109F-5D1D-94C1-88316F12ADCA"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-EFB2A64D-109F-5D1D-94C1-88316F12ADCA"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-53E2D165-76D4-3329-9834-B64EEC11604F"><span class="apiname">CPositioner::IsPartialUpdateAllowed()</span></a>     A client application may specify that it accepts incomplete location information. Incomplete location information is only required to contain the time and the PSY ID. It is not required to include latitude or longitude. For example, a GPS PSY may read NMEA sentences, which does not include a fix because the terminal is indoors. The GPS PSY could still return satellite information to the client if partial updates are allowed. The PSY can check if partial location information is accepted by the client by calling <samp class="codeph">IsPartialUpdateAllowed()</samp>. If <samp class="codeph">ETrue</samp> is returned, then the PSY can return an incomplete fix.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-AEA081B2-E438-51D5-8CE8-956BD929AE32"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-AEA081B2-E438-51D5-8CE8-956BD929AE32"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-C7BB2CA5-3351-3117-B859-C3014B80653C"><span class="apiname">CPositioner::GetRequiredPositionQuality()</span></a>    A client application may specify a required position quality. The PSY can use the position quality if it is possible to specify the required quality of position to the positioning technology that it encapsulates. <samp class="codeph">GetRequiredPositionQuality()</samp> returns <samp class="codeph">KErrNotFound</samp> if no quality has been specified by the client.    Important Note:  <samp class="codeph">
                     GetRequiredPositionQuality()</samp> is not currently supported and always returns <samp class="codeph">KErrNotFound</samp>.  </li>
 </ol>
 </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-83717E31-D4E4-5937-A6D0-6A8368798C8B"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-83717E31-D4E4-5937-A6D0-6A8368798C8B"><!-- --></a><span>Write code to handle a single location request </span>  When a client requests location information from the Location Framework, the framework forwards the request to a PSY instance. <samp class="codeph">CPositioner</samp> provides a pure virtual method <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-03A37FAC-3129-3483-AC7F-C17A46D9F431"><span class="apiname">CPositioner::NotifyPositionUpdate()</span></a> that must be implemented by the PSY in order to handle a position request.    <samp class="codeph">NotifyPositionUpdate()</samp> is an asynchronous call and must be implemented in the PSY to return at once. If positioning takes time, it should be implemented using active objects, otherwise the Location Server is blocked for the time that a position fix is being obtained by the PSY. <samp class="codeph">NotifyPositionUpdate()</samp> has a <samp class="codeph">TRequestStatus</samp> parameter which is used to signal that the position acquisition is complete.    <samp class="codeph">NotifyPositionUpdate</samp> () also has a <a href="GUID-73D6F438-C270-33B9-974B-D4D1583E1738.html"><span class="apiname">TPositionInfoBase</span></a> as an output parameter. This object is used to pass position information back to the client. <samp class="codeph">TPositionInfoBase</samp> is an abstract class and the actual class hierarchy of the position information object can be obtained by calling <a href="GUID-73D6F438-C270-33B9-974B-D4D1583E1738.html#GUID-73D6F438-C270-33B9-974B-D4D1583E1738__GUID-CD86897E-5924-3758-BD92-1D324BE4287C"><span class="apiname">TPositionInfoBase::PositionClassType()</span></a>. The PSY must cast the position information object to the actual subclass and the appropriate position information filled in. PSYs can support different sets of position information classes but <a href="GUID-D5B2E933-209D-3871-8E27-CC5C8855C745.html"><span class="apiname">TPositionInfo</span></a> and <a href="GUID-ADB30502-C84C-3027-B457-9150FA4AC510.html"><span class="apiname">HGenericPositionInfo</span></a> are mandatory. The position information class must store data as specified by the WGS84 geodetic datum.   The PSY must also report the data quality status while returning position information.   This sequence diagram of figure 1 shows the steps that are involved when the Location Framework makes a request for a position update from a PSY.   <div class="fignone" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E194C421-6C62-5538-809C-DB33A454B930"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E194C421-6C62-5538-809C-DB33A454B930"><!-- --></a><span class="figcap">Figure 1. 
                  Figure 1. Handling a request for position information. 
                </span> <img src="GUID-2D86812F-5DB1-5FD9-A199-AE344D5A10C8_d0e460328_href.png"/></div>
   The following code example shows how to process a location request.   <pre class="codeblock" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8D2520E2-38D9-5412-A1C7-B57B88998576"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8D2520E2-38D9-5412-A1C7-B57B88998576"><!-- --></a>void CPosExamplePositioner::NotifyPositionUpdate(
    TPositionInfoBase&amp; aPosInfo,
    TRequestStatus&amp; aStatus)
    {
    TRequestStatus *statusPtr = &amp;aStatus;

    // NotifyPositionUpdate must return quickly. It should
    // be implemented as asynchronous but since Example PSY
    // is very fast, we fetch the position synchronously.

    // The position info object is at least a TPositionInfo
    // Hence casting it to TPositionInfo. Ideally the class type
    // should be obtained and then cast to the specified
    // position information class.
    TPositionInfo* aPosInfo =
        static_cast&lt;TPositionInfo*&gt;(&amp;aPosInfo);
    TPosition pos;
    // Calculate the position and fill in the position info
    // object
    pos.SetCoordinate(65.345, 11.456);
    
    // set horizontal and vertical accuracy
    pos.SetAccuracy(10.0, 30.0);
    
    // set time of fix
    pos.SetCurrentTime();

    // Set position in position info.
    posInfo-&gt;SetPosition(pos);

    User::RequestComplete(statusPtr, KErrNone);
    } 
</pre>
  </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-100F3359-EDCF-5555-A38B-B379F0A7C572"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-100F3359-EDCF-5555-A38B-B379F0A7C572"><!-- --></a><span>Write code to handle periodic location requests (tracking) </span>  A client application can request periodic position updates from the Location Framework. This is known as tracking. If the client application continues to reissue position requests as soon as the last request completes then it receives periodic position updates.   The Location Framework sends a position request to a PSY when a location update is required by a client. The PSY must be ready to give position information as soon as the Location Framework sends a request. A PSY needs to know about the requirement for periodic position requests if the underlying positioning technology needs to be kept powered in order to provide fast position updates. Conversely, a PSY can go into standby mode if it knows that it is a long time until the next request.   To support tracking the PSY must implement the following virtual methods in <samp class="codeph">CPositioner</samp>:  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F84A38AA-F86B-5049-984D-296896BB7FAA"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F84A38AA-F86B-5049-984D-296896BB7FAA"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-65D1CB9C-B8AA-54AF-A4E0-0527F3BC0A52"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-65D1CB9C-B8AA-54AF-A4E0-0527F3BC0A52"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-EF23126A-7869-3113-9ED6-530BB57D66A2"><span class="apiname">CPositioner::TrackingOverridden()</span></a> must be implemented by the PSY <samp class="codeph">CPositioner</samp> subclass to return <samp class="codeph">ETrue</samp>. This indicates that the PSY implements specific logic to handle periodic position updates. The default implementation for <samp class="codeph">TrackingOverridden</samp> in <samp class="codeph">CPositioner</samp> returns <samp class="codeph">EFalse</samp>.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-57D535CB-67A1-5027-92D7-4998926556E8"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-57D535CB-67A1-5027-92D7-4998926556E8"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-C0CCADDD-6CD8-37E9-BC7F-19ECF0F72C84"><span class="apiname">CPositioner::StopTracking()</span></a> must be overridden by the PSY <samp class="codeph">CPositioner</samp> subclass. It is called by the Location Framework to signal that the tracking session has been closed so the PSY can put the positioning technology hardware into standby mode. The default implementation for <samp class="codeph">StopTracking() </samp> in <samp class="codeph">CPositioner</samp> does not perform any action.   If a PSY implementation returns <samp class="codeph">ETrue</samp> from <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-EF23126A-7869-3113-9ED6-530BB57D66A2"><span class="apiname">CPositioner::TrackingOverridden()</span></a> then it should provide an implementation of <samp class="codeph">StopTracking()</samp>.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-EFE1E5CA-E9A4-56BE-82C1-5A2EA31BD985"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-EFE1E5CA-E9A4-56BE-82C1-5A2EA31BD985"><!-- --></a><span/><br/>  <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-4DFC679F-F6F6-39A1-91DF-69661ABC0FA8"><span class="apiname">CPositioner::StartTrackingL()</span></a> must be overridden by the PSY <samp class="codeph">CPositioner</samp> subclass. It is called by the Location Framework to signal that the Location Server has started a tracking session. The PSY can start the positioning technology specific device/protocol and keep it in state where position information can be obtained quickly.   The periodicity of position updates requested by theclient application is passed as an input parameter to this method. If the PSY cannot support the periodicity, it must return fixes as frequently as possible. The default implementation for <samp class="codeph">StartTrackingL()</samp> in <samp class="codeph">CPositioner</samp> leaves with <samp class="codeph">KErrNotSupported</samp>. If the PSY implementation returns <samp class="codeph">ETrue</samp> from <samp class="codeph">TrackingOverridden</samp> then it needs to provide an implementation of <samp class="codeph">StartTrackingL()</samp>.  </li>
 </ol>
  Figure 2 shows the steps that are involved when the Location Framework initiates a periodic position request from a PSY:   <div class="fignone" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-B62DCC66-0C97-594A-A22F-EEC88E507924"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-B62DCC66-0C97-594A-A22F-EEC88E507924"><!-- --></a><span class="figcap">Figure 2. 
                  Figure 2. Handling periodic position determination request 
                </span> <img src="GUID-474654BE-D73E-5249-B7E3-7F2656DAB190_d0e460457_href.png"/></div>
  </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-1FC0C372-4FA8-5F16-86DC-158F09F4246F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-1FC0C372-4FA8-5F16-86DC-158F09F4246F"><!-- --></a><span>Write code to handle request cancellation </span>  When the client requests cancellation of an outstanding location request from the Location Framework, the framework forwards the request to the corresponding PSY instance. The <samp class="codeph">CPositioner</samp> provides a pure virtual method <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-D28C6BC6-69B8-3D69-BE46-5745C5B77A4D"><span class="apiname">CPositioner::CancelNotifyPositionUpdate()</span></a> that has to be implemented by the PSY in order to handle cancellation of a position request.    <samp class="codeph">CancelNotifyPositionUpdate()</samp> must be implemented to cancel any outstanding request in the PSY. Typically this involves cancelling some active object. If there is an outstanding request, it must be completed with the code <samp class="codeph">KErrCancel</samp>.   Figure 3 shows the steps that are involved when the Location framework initiates a cancel request for an outstanding position request.   <div class="fignone" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-BC2EE2F2-4F13-5EFA-B80B-B79E90EA5B3E"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-BC2EE2F2-4F13-5EFA-B80B-B79E90EA5B3E"><!-- --></a><span class="figcap">Figure 3. 
                  Figure 3. Cancelling a position determination request 
                </span> <img src="GUID-502C26EB-BB1F-547C-B93B-8A516D545561_d0e460492_href.png"/></div>
   <pre class="codeblock" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8346C01C-AE15-5D30-9C66-4B2EB249B35F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8346C01C-AE15-5D30-9C66-4B2EB249B35F"><!-- --></a>void CPosExamplePositioner::CancelNotifyPositionUpdate()
    {
    // Since the Example PSY can deliver a position very
    // fast it has been implemented synchronously which
    // means that there will never be an outstanding
    // request to cancel.
    
    // For your specific PSY cancel any asynchronous request
    // that was made to get the position information from the
    // underlying positioning technology.
    }
</pre>
  </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E07D18D1-6ABD-55B2-B035-F5CF259D6A39"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E07D18D1-6ABD-55B2-B035-F5CF259D6A39"><!-- --></a><span>Write code to support advanced PSY functionality </span>   <samp class="codeph">CPositioner</samp> defines virtual functions that are required to implement advanced functionality. It provides a default implementation for these functions and the PSY can override these if it needs to implement any of the advanced PSY features:  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-A0D1A0CB-C7FB-500E-9F44-C45C070F069C"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-A0D1A0CB-C7FB-500E-9F44-C45C070F069C"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-87026FC2-ED9A-52E5-9E75-F63CCC4F5D91"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-87026FC2-ED9A-52E5-9E75-F63CCC4F5D91"><!-- --></a><span/><br/> ServiceL   The <a href="GUID-D0318BB6-0B9F-5A1C-AB0B-61BA22D28661.html" title="Client applications use the Location Acquisition API to obtain the position of the mobile device from the LBS subsystem.">Location Acquisition API</a> can be extended to support PSY specific method calls. This means that <a href="GUID-1EAEB7EF-0AC7-37C7-B35F-C9B780FFC575.html"><span class="apiname">RPositioner</span></a> can be sub-classed to define the new methods. The methods are implemented to pack their parameters and send them to the Location Server by calling <samp class="codeph">SendReceive()</samp>. The Location Server forwards such requests to the <samp class="codeph">ServiceL</samp> () method of the PSY and passes an <samp class="codeph">RMessage2</samp> object that contains the request information. <samp class="codeph">RMessage2</samp> is handled as in an ordinary client/server request. <samp class="codeph">ServiceL</samp> is a virtual function and can be overridden by a PSY developer to support PSY specific method calls. This feature is reserved for future use.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-816390F9-835C-5907-95F4-7DF5004AB2DD"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-816390F9-835C-5907-95F4-7DF5004AB2DD"><!-- --></a><span/><br/> Handling parallel requests    <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html"><span class="apiname">CPositioner</span></a> is instantiated once for each open client handle, which means that the PSY may have to handle many position requests at the same time. However, the position technology used by the PSY may not support parallel requests. This means that the positioner instances cannot work independently. The PSY needs a centralised request control. The suggested solution is to use a singleton object, i.e. an object which is instantiated when the PSY is loaded (when the first <samp class="codeph">CPositioner</samp> object is instantiated) and which is not deleted until the PSY is unloaded (when the last <samp class="codeph">CPositioner</samp> object is deleted). All positioner objects forward their requests to the singleton object which implements the strategy for how parallel requests should be handled. Since a PSY is a DLL, the thread local storage must be used to store the singleton.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-0E769C52-8887-5596-841B-34FF47C2562C"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-0E769C52-8887-5596-841B-34FF47C2562C"><!-- --></a><span/><br/>  <samp class="codeph">Power management</samp>    The PSY developer should consider power management. If the positioning technology draws much power, the PSY may enter the power save mode when it has not been used for a while. In such cases the PSY should use tracking (periodic position update requests) effectively and try to keep the device in standby mode when position information is not required immediately.  </li>
 </ol>
 </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7F7A8635-ED93-54C0-8C89-238298680196"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7F7A8635-ED93-54C0-8C89-238298680196"><!-- --></a><span>Write code to report the PSY device status </span>  A PSY has to report its status to the Location Framework when it is being used. There are two types of status that must be reported:  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-81D2A032-6CB4-5A44-B80F-CC07CE2FF4A6"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-81D2A032-6CB4-5A44-B80F-CC07CE2FF4A6"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-6220AB06-B2DB-5E36-A02E-6CF9B160093A"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-6220AB06-B2DB-5E36-A02E-6CF9B160093A"><!-- --></a><span/><br/> The status of the device or positioning technology that is being used by the PSY for obtaining the position information.  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-0558FCE2-B278-5117-901A-8C2413E4158F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-0558FCE2-B278-5117-901A-8C2413E4158F"><!-- --></a><span/><br/> The status about the quality of the position fix that the PSY is providing at the moment. The data quality status indicates the accuracy of the data returned by the PSY.  </li>
 </ol>
  In order to report these statuses the PSY needs to use the <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-66091F9F-A685-3A47-8B15-74257B56D4DC"><span class="apiname">CPositioner::PositionerStatus()</span></a> method provided by the <samp class="codeph">CPositioner</samp> class. This method returns an <a href="GUID-86CB276D-F920-3115-858E-31AF13EABD30.html"><span class="apiname">MPositionerStatus</span></a> interface through which the status can be reported by calling <a href="GUID-86CB276D-F920-3115-858E-31AF13EABD30.html#GUID-86CB276D-F920-3115-858E-31AF13EABD30__GUID-B65B8E39-9AD4-34EA-9961-4FED28AB9D16"><span class="apiname">MPositionerStatus::ReportStatus()</span></a>.  <a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C1877303-E171-5F1F-AB69-97440AD638CE"><!-- --></a><ol type="a" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C1877303-E171-5F1F-AB69-97440AD638CE"><li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7AB82D66-BB6A-5BB0-8A6D-1D6B0F43900F"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7AB82D66-BB6A-5BB0-8A6D-1D6B0F43900F"><!-- --></a><span/><br/> Write code to report device status   A PSY must report the following device statuses:   <ul><li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-3B1A1EA1-494A-5C7A-AEBD-87AC96A36C24"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-3B1A1EA1-494A-5C7A-AEBD-87AC96A36C24"><!-- --></a><p>When the Location Framework loads a PSY, the PSY initializes the device providing the location information. Once the device is ready the PSY must report <samp class="codeph">EDeviceReady</samp>. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-CF70A8B4-E567-543A-AC9D-A0AF5E47C24E"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-CF70A8B4-E567-543A-AC9D-A0AF5E47C24E"><!-- --></a><p>When the device is used by the PSY to obtain a location fix then the PSY must report a <samp class="codeph">EDeviceActive</samp> status. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-D6C6BC11-28E9-58ED-B7D2-A40F2CEA549C"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-D6C6BC11-28E9-58ED-B7D2-A40F2CEA549C"><!-- --></a><p>The PSY must also set the status to <samp class="codeph">EDeviceInactive</samp> when the PSY is unloaded (i.e. when the last <samp class="codeph">CPositioner</samp> instance is destroyed). </p>
 </li>
 </ul>
   Apart from the statuses listed above there are a few other device status which a PSY can optionally report:   <ul><li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-6A0DE1E7-9831-52FA-A31A-ED4DA418593B"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-6A0DE1E7-9831-52FA-A31A-ED4DA418593B"><!-- --></a><p>When the PSY is loaded and before the device is ready, the PSY can report a <samp class="codeph">EDeviceIntialising</samp> status. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-BD098E6F-2425-5C6F-9061-618C9E72C2E8"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-BD098E6F-2425-5C6F-9061-618C9E72C2E8"><!-- --></a><p>The PSY can report <samp class="codeph">EDeviceStandby</samp> if the device has been moved to a sleep or power save mode. At this state it is assumed that the device cannot retrieve location fix immediately. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8C0009D2-872B-564F-ABF6-4BFB3764BE0E"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-8C0009D2-872B-564F-ABF6-4BFB3764BE0E"><!-- --></a><p>The PSY can report a <samp class="codeph">EDeviceError</samp> if there are some problems in using the device. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E8B43FFD-9B02-53A9-A502-594A7607E524"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-E8B43FFD-9B02-53A9-A502-594A7607E524"><!-- --></a><p>The PSY can report <samp class="codeph">EDeviceDisabled</samp> if the device is unavailable to obtain position information. </p>
 <p>Note: The device may still be working properly hence this status is different from <samp class="codeph">EDeviceError</samp>. </p>
 </li>
 </ul>
  </li>
 <li class="substepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C6B5F879-EF34-5A95-AF37-CA47B0CF7C66"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C6B5F879-EF34-5A95-AF37-CA47B0CF7C66"><!-- --></a><span/><br/> Write code to report data quality status   A PSY must report the quality of the position information that is obtained from the device. The following data quality statuses can be reported:   <ul><li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C3981254-FA2F-570F-911F-2A66CF278767"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-C3981254-FA2F-570F-911F-2A66CF278767"><!-- --></a><p>If the position fix contains all the required information then the PSY should report a <samp class="codeph">EDataQualityNormal</samp> status. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7C1B588C-A22E-55D1-8CDA-E7771599B95E"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-7C1B588C-A22E-55D1-8CDA-E7771599B95E"><!-- --></a><p>If the position information returned by the device does not contain all the necessary fields for a position fix then it should report <samp class="codeph">EDataQualityPartial</samp>. </p>
 </li>
 <li id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-806308A3-AE13-5676-A844-FCDAFBDE6C03"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-806308A3-AE13-5676-A844-FCDAFBDE6C03"><!-- --></a><p>If the PSY is unable to obtain any position information from the device then it should report a <samp class="codeph">EDataQualityLoss status</samp>. Note that in this case it is possible that the device is working properly but it is unable to obtain the position information. </p>
 </li>
 </ul>
   The <samp class="codeph">CPositioner</samp> subclass is instantiated by the Location Framework for each open client session. Hence it is possible to have multiple instances of the <samp class="codeph">CPositioner</samp> subclass implemented by the PSY, which means that the PSY may have to handle more than one position request at a time. When handling such parallel requests, the status tracking mechanism in the PSY must also be centralised and the status should be reported only through one of the <samp class="codeph">CPositioner</samp> instances. To achieve this the PSY should report status using a singleton class.  </li>
 </ol>
 </li>
<li class="stepexpand" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F6E5F16A-E7AB-579C-9382-7F989B3707A8"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-F6E5F16A-E7AB-579C-9382-7F989B3707A8"><!-- --></a><span>Write an ECOM factory function </span>  A PSY is an ECOM plug-in and it must follow certain rules in order to be loaded by the Location Framework. To enable loading, the PSY must define the following function at ordinal 1:   <pre class="codeblock" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-1BD2AB98-6279-51E3-AB23-B7E1A251C699"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-1BD2AB98-6279-51E3-AB23-B7E1A251C699"><!-- --></a>const TImplementationProxy* ImplementationGroupProxy(TInt&amp; aTableCount)</pre>
    <samp class="codeph">TImplementationProxy</samp> is defined by ECOM and it contains information about the available factory functions. The PSY must set aTableCount to 1 and return <samp class="codeph">TImplementationProxy</samp>, which points to the PSY factory function: <a href="GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350.html#GUID-0CA8AEC1-FF5E-3556-ACBD-0D4277CF1350__GUID-D9F3B20A-A6EC-366B-9457-E92B9F9B4C60"><span class="apiname">CPositioner::NewL()</span></a> <samp class="codeph"/>in the <samp class="codeph">CPositioner</samp> subclass.   Providing several implementations within one PSY is not supported.   The example PSY exports the <a href="GUID-F23790E7-839F-30A4-89D7-1CB30AEA6489.html#GUID-F23790E7-839F-30A4-89D7-1CB30AEA6489__GUID-A0334E06-8BF8-38C3-AC53-885D98FADDB1"><span class="apiname">CExamplePositioner::NewL()</span></a> method by providing the following code:   <pre class="codeblock" id="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-9C38DE9A-3365-5E28-91C4-137B7BF69DCF"><a name="GUID-0B4D4675-2CFB-5964-A869-7275202AC71D__GUID-9C38DE9A-3365-5E28-91C4-137B7BF69DCF"><!-- --></a>// Note! UID below is implementation UID, not DLL UID.
const TImplementationProxy KFactoryPtr =
    {{KPosExamplePSYImplUid}, (TProxyNewLPtr) CPosExamplePositioner::NewL};
 

EXPORT_C const TImplementationProxy* ImplementationGroupProxy(
    TInt&amp; aTableCount)
    {
    aTableCount = 1;
    return &amp;KFactoryPtr;

    }
</pre>
  </li>
</ol>
 <div class="section"><p>After implementing the code necessary to create the PSY, a device creator must package it as an ECOM plug-in that can be loaded by the LBS subsystem. </p>
 <p>See <a href="GUID-2955A35E-1215-5C4A-9C24-0106FB75E295.html" title="This section describes how to package the PSY as an ECOM plug-in that can be loaded by the LBS subsystem.">Provide ECOM registry information for a PSY</a> for more information. </p>
 </div>
 </div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-CEBAC67F-DEFE-51EF-93CE-2FA61AA68997.html" title="The documents in this section describe how to use the Positioning Plug-In API to create a Positioning Plug-In.">Positioning Plug-In (PSY) Tutorial</a></div>
</div>
<div class="relinfo reltasks"><strong>Related tasks</strong><br/>
<div><a href="GUID-86AD79A5-E18D-56C6-997A-5E2B24FEE80D.html" title="This document describes how to use the Positioning Plug-in API.">Positioning
                Plug-in API Tutorial</a></div>
</div>
</div>   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>