<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Example IETF Profile Agent Plug-in"/>
<meta name="DC.Relation" scheme="URI" content="GUID-BDD99F37-FD44-56FF-A849-015FCEE8F2D9.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-6425B722-4095-56E3-9198-70BA3E06C617.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-BDD99F37-FD44-56FF-A849-015FCEE8F2D9.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Example IETF Profile Agent Plug-in</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2397554 id2397680 id2397836 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-6425B722-4095-56E3-9198-70BA3E06C617.html">Multimedia Protocols Guide</a> &gt; <a href="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html">SIP</a> &gt; <a href="GUID-BDD99F37-FD44-56FF-A849-015FCEE8F2D9.html">SIP Profile Agent API</a> &gt; </div>
<h1 class="topictitle1">Example
IETF Profile Agent Plug-in</h1>
<div>
<p>The IETF Profile Agent plug-in is an ECOM plug-in that uses the SIP Profile
Agent plug-in API. The IETF Profile Agent plug-in enters the IETF registration
details in the request headers. </p>

<p>The main functions of the ECom plug-in are: </p>

<ul>
<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-7F8A4189-D118-57CD-9F1B-E444F83B1BE0"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-7F8A4189-D118-57CD-9F1B-E444F83B1BE0"><!-- --></a><p>to register, update,
and deregister IETF SIP profiles that use the SIP Client API </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-BDD4FA8B-7981-5849-B91F-5A4E7E237CAA"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-BDD4FA8B-7981-5849-B91F-5A4E7E237CAA"><!-- --></a><p>to handle many SIP connections
when several SIP profiles are enabled at the same time but, do not use the
same Internet Access Point (IAP) </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-3F0718FF-A10C-5FE4-99EE-6B9FA6669084"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-3F0718FF-A10C-5FE4-99EE-6B9FA6669084"><!-- --></a><p>to provide HTTP Digest
settings from SIP Profiles to the SIP Client API </p>
 </li>

</ul>

<p>The plug-in uses the SIP Profile Finite State Machine (FSM) API which implements
a state machine for SIP Profiles. The FSM API responds to registration events
and notifies the client about changes in the profile registration status.
It also provides common error handling and handling of connection state changes. </p>

<p>The following sections provide information about the uses of the plug-in
and the source code for the plug-in: </p>

<ul>
<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-ECA6D5CE-6D2D-50B2-8A76-3AA28E75DE8C"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-ECA6D5CE-6D2D-50B2-8A76-3AA28E75DE8C"><!-- --></a><p> <a href="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B.html#GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-CFB776D6-399E-55E1-ACAA-06B29DC695B6">Typical uses of the IETF Profile Agent plug-in</a>  </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-B91486BC-DEFE-5085-B5E9-E16FCF01D5BF"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-B91486BC-DEFE-5085-B5E9-E16FCF01D5BF"><!-- --></a><p> <a href="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B.html#GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-46D9399E-F3F4-5A7F-955B-4D2D08726029">Source code</a>  </p>
 </li>

</ul>

<div class="section" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-CFB776D6-399E-55E1-ACAA-06B29DC695B6"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-CFB776D6-399E-55E1-ACAA-06B29DC695B6"><!-- --></a><h2 class="sectiontitle">Typical uses
of the IETF Profile Agent plug-in</h2> <p><strong>Registering an IETF profile </strong> </p>
 <p>Load
the IETF Profile Agent plug-in and register an IETF profile. The following
steps describe the IETF profile registration process: </p>
 <a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-F23557DF-26C4-51CC-9D05-7E9E50F76B72"><!-- --></a><ol id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-F23557DF-26C4-51CC-9D05-7E9E50F76B72">
<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-450741AA-7FC0-561E-AD25-FD1394E3897F"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-450741AA-7FC0-561E-AD25-FD1394E3897F"><!-- --></a><p>The SIP Profile Server
sends a profile registration request to the IETF plug-in. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-C594C73F-900E-541C-A3AF-83AF7338267B"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-C594C73F-900E-541C-A3AF-83AF7338267B"><!-- --></a><p>The plug-in finds a
context for the profile that use the connection context and passes the registration
request to the profile context class. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-CC13A752-DCB0-5B8E-B72C-15120CC2C360"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-CC13A752-DCB0-5B8E-B72C-15120CC2C360"><!-- --></a><p>The profile context
class passes the request to the SIP Profile FSM class, which sets the profile
state to <strong>RegistrationInProgressState</strong> and passes the request to the
SIP Stack. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-DE0DD98D-BC3C-5A62-B6E3-55F5CACA9D50"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-DE0DD98D-BC3C-5A62-B6E3-55F5CACA9D50"><!-- --></a><p>The SIP Stack responds
to the profile context after the registration process is complete. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-34184F96-0E54-5C2C-951A-E991A885ACB6"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-34184F96-0E54-5C2C-951A-E991A885ACB6"><!-- --></a><p>The profile state is
changed to <strong>RegisteredState</strong> and the SIP Profile Server is notified. </p>
 </li>

</ol>
 <p>The following sequence diagram shows the call flow of IETF profile
registration process. </p>
 <div class="fignone" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-0C9B80F8-0061-5597-A216-ABF1C545FD52"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-0C9B80F8-0061-5597-A216-ABF1C545FD52"><!-- --></a><span class="figcap">Figure 1.                  IETF profile registration sequence diagram       
       </span>

<img src="GUID-8D72AE33-AF61-5AD7-A40D-A2918474DD0D_d0e556900_href.png"/>
</div>
 <p><strong>Updating an IETF profile</strong> </p>
 <p>To update an IETF profile,
the IETF Profile Agent plug-in is loaded and the profile is in the <strong>RegisteredState</strong> state.
The following steps describe how to update the IETF profile: </p>
 <a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-898A25C5-45AA-5066-BAC1-89509F26873D"><!-- --></a><ol id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-898A25C5-45AA-5066-BAC1-89509F26873D">
<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-EF327FC8-CA28-5865-8BA4-2F432B194F91"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-EF327FC8-CA28-5865-8BA4-2F432B194F91"><!-- --></a><p>The SIP Profile Server
sends a request to the IETF plug-in to update the IETF profile. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-AB222C74-55F3-5BBD-97CF-629C3FFAFC45"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-AB222C74-55F3-5BBD-97CF-629C3FFAFC45"><!-- --></a><p>The plug-in finds a
context for the profile that use the connection context and passes the profile
update request to the profile context class. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-76F711A8-FB17-594D-8D3C-FEB4CA877D40"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-76F711A8-FB17-594D-8D3C-FEB4CA877D40"><!-- --></a><p>The profile context
class initiates a request to deregister the old profile, sets the profile
state to <strong>DeregistrationInProgressState</strong> and passes the request to the
SIP Stack. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-51B96824-EB8F-5E25-A0A0-FD14264D7E81"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-51B96824-EB8F-5E25-A0A0-FD14264D7E81"><!-- --></a><p>The SIP Stack responds
to the profile context after the deregistration process is complete and the
profile state is set to <strong>DeregisteredState</strong>. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-C4963BDD-F871-5C18-8C5B-F99027D0B406"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-C4963BDD-F871-5C18-8C5B-F99027D0B406"><!-- --></a><p>The updated profile
is registered and the SIP Profile Server is notified. </p>
 </li>

</ol>
 <p>The following sequence diagram shows the call flow of updating the
IETF profile: </p>
 <div class="fignone" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-0DF3456B-F0B8-550C-B3B0-CA45C8B30E5C"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-0DF3456B-F0B8-550C-B3B0-CA45C8B30E5C"><!-- --></a><span class="figcap">Figure 2.                  IETF profile update sequence diagram             
 </span>

<img src="GUID-7E8DA853-BE41-5C8D-B286-9F5F7992FD2C_d0e556956_href.png"/>
</div>
 <p><strong>Deregistering an IETF profile</strong> </p>
 <p>To deregister an IETF
profile, the IETF Profile Agent plug-in is loaded and the profile is in the <strong>RegisteredState</strong>.
The following steps describe the IETF profile deregistration process: </p>
 <a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-7274958A-CF11-57DB-A0E0-B4A965F2C719"><!-- --></a><ol id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-7274958A-CF11-57DB-A0E0-B4A965F2C719">
<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4303B836-2167-5020-9CED-81444F876DDA"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4303B836-2167-5020-9CED-81444F876DDA"><!-- --></a><p>The SIP Profile Server
sends a profile deregistration request to the IETF plug-in. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-9F6A96E6-7199-5C83-947A-4A3625F12F6D"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-9F6A96E6-7199-5C83-947A-4A3625F12F6D"><!-- --></a><p>The plug-in finds a
context for the profile that use the connection context and passes the deregistration
request to the profile context class. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-E00A6519-AEC9-526A-A4F7-88DB5317C324"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-E00A6519-AEC9-526A-A4F7-88DB5317C324"><!-- --></a><p>The profile context
class passes the request to the SIP Profile FSM class, which sets the profile
state as <strong/><strong>DeregistrationInProgressState</strong> and passes the request
to the SIP Stack. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-EAF13DE8-29B1-5962-975B-07EA6B1C106D"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-EAF13DE8-29B1-5962-975B-07EA6B1C106D"><!-- --></a><p>The SIP Stack responds
to the profile context after the deregistration process is complete. </p>
 </li>

<li id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4F19F07B-6D1F-54C2-B92E-4508B259A50D"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4F19F07B-6D1F-54C2-B92E-4508B259A50D"><!-- --></a><p>The profile state is
changed to <strong>DeregisteredState</strong> and the SIP Profile Server is notified. </p>
 </li>

</ol>
 <p>The following sequence diagram shows the call flow of IETF profile
deregistration process: </p>
 <div class="fignone" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-DE79B542-C6C1-504D-B8C6-493C78208287"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-DE79B542-C6C1-504D-B8C6-493C78208287"><!-- --></a><span class="figcap">Figure 3.                  IETF profile deregistration sequence diagram     
         </span>

<img src="GUID-DDD07E37-E5BE-5187-9C62-A3F4F9343C2A_d0e557013_href.png"/>
</div>
 </div>

<div class="section" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-46D9399E-F3F4-5A7F-955B-4D2D08726029"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-46D9399E-F3F4-5A7F-955B-4D2D08726029"><!-- --></a><h2 class="sectiontitle">Source code</h2> <p>Here
is the source for the IETF Profile Agent plug-in: </p>
 <p><strong>sipietfprofileagent.h</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-F2C978BC-AC9D-53FB-9621-34509BC773BF"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-F2C978BC-AC9D-53FB-9621-34509BC773BF"><!-- --></a>// sipietfprofileagent.h

#ifndef CSIPIETFPROFILEAGENT_H
#define CSIPIETFPROFILEAGENT_H

//  INCLUDES
#include &lt;e32base.h&gt;
#include "sipprofileagent.h"
#include "sipprofileagentobserver.h"
#include "sipprofilefsmuser.h"
#include "sipobserver.h"
#include "siphttpdigestchallengeobserver2.h"


//FORWARD DECLARATIONS
class CSIP;
class CSIPHttpDigest;
class TSIPProfileTypeInfo;
class CSIPIetfConnectionContext;
class CSIPPrflInitState;
class CSIPPrflResolvingProxiesState;
class CSIPPrflRegisterRequestedState;
class CSIPPrflRegistrationInProgressState;
class CSIPPrflRegisteredState;
class CSIPPrflDeregisterRequestedState;
class CSIPPrflDeregistrationInProgressState;
class CSIPPrflRegisterDelayRequestedState;
class CSIPIetfProfileContext;
class CSIPProfileQueueHandling;

// CLASS DECLARATION
/**
*  Registers profiles and maintains
*  profile registrations as per RFC3261.
*  
*  @lib n/a
*/
class CSIPIetfProfileAgent: 
    public CSIPProfileAgent, 
    public MSIPProfileAgentObserver,
    public MSIPProfileFSMUser,
    public MSIPObserver,
    public MSIPHttpDigestChallengeObserver2
    {
    public: // Constructors and destructor
           
        /**
        * Two-phased constructor.
        * @param aInitParams parameters passed in the construction
        */
        static CSIPIetfProfileAgent* NewL(TAny* aInitParams);
    
        /**
        * Destructor.
        */
        virtual ~CSIPIetfProfileAgent();

    public: // From CSIPProfileAgent

        const TSIPProfileTypeInfo&amp; Type() const;
        
        CSIPConcreteProfile* CreateL();
    
        void RegisterL(
            CSIPConcreteProfile&amp; aSIPConcreteProfile);

        void UpdateL(
            CSIPConcreteProfile&amp; aNewProfile, 
            CSIPConcreteProfile&amp; aOldProfile);

        void DeregisterL(
            CSIPConcreteProfile&amp; aSIPConcreteProfile);

        TInt GetProfileState(
            CSIPConcreteProfile::TStatus&amp; aState, 
            CSIPConcreteProfile&amp; aProfile) const;

        TBool IsIdle();
        
        TBool RegisterPending(CSIPConcreteProfile&amp; aSIPProfile) const;

        TInt TerminateHandling(CSIPConcreteProfile&amp; aProfile);

        TInt Extension(TInt aOperationCode, TAny* aParams); 

    public: // From MSIPProfileAgentObserver
    
        void SIPProfileStatusEvent(
            CSIPConcreteProfile&amp; aProfile,
            TUint32 aContextId);

        void SIPProfileErrorEvent(
            CSIPConcreteProfile&amp; aProfile,
            TInt aError);

        TBool ProceedRegistration(CSIPConcreteProfile&amp; aProfile);
        
        void GetFailedProfilesL( 
            const TSIPProfileTypeInfo&amp; aType,
            RPointerArray&lt;CSIPConcreteProfile&gt;&amp; aFailedProfiles) const;    


    public: // From MSIPProfileFSMUser

        void RegisterProfileL(
            CSIPConcreteProfile&amp; aSIPConcreteProfile);

        void DeregisterProfileL(
            CSIPConcreteProfile&amp; aSIPConcreteProfile);

        void RetryProfileRegistrationL( 
            CSIPConcreteProfile&amp; aSIPProfile );

        TBool AddProfileIntoQueue( 
            CSIPConcreteProfile&amp; aSIPConcreteProfile ) const;

        void RegisterProfileAfterQueueL( 
            CSIPConcreteProfile&amp; aSIPConcreteProfile );

        void DeregisterProfileAfterQueueL( 
            CSIPConcreteProfile&amp; aSIPConcreteProfile );

        void RetryProfileRegistrationAfterQueueL( 
            CSIPConcreteProfile&amp; aSIPConcreteProfile );
            
        TBool IsInQueue( 
            CSIPConcreteProfile&amp; aSIPProfile ) const;

        void SetInterimProfile( CSIPConcreteProfile* 
                                            aSIPConcreteProfile );

    public: // From MSIPObserver

        void IncomingRequest(
            TUint32 aIapId,
            CSIPServerTransaction* aTransaction);

        void TimedOut(CSIPServerTransaction&amp; aTransaction);

    public: // From MSIPHttpDigestChallengeObserver2
    
        void ChallengeReceived(const CSIPClientTransaction&amp; aTransaction);

        void ChallengeReceived(const CSIPRefresh&amp; aRefresh);


    private: // Constructors

        /**
        * C++ default constructor.
        */
        CSIPIetfProfileAgent(TSIPProfileAgentInitParams* aInitParams);

        /**
        * By default Symbian 2nd phase constructor is private.
        */
        void ConstructL();

        
    private: // New functions        

        /**
        * Provides profile context
        * @param aProfile a profile
        * @return a profile context
        */
        CSIPIetfProfileContext&amp; ProvideProfileContextL(CSIPConcreteProfile&amp; aProfile);

        /**
        * Finds profile context
        * @param aSIPConcreteProfile a profile
        * @return profile context, the ownership is not transferred
        */
        CSIPIetfProfileContext* FindProfileContext(CSIPConcreteProfile&amp; aSIPConcreteProfile) const;

        /**
        * Finds profile context
        * @param aProfileId identifier of the profile
        * @return profile context, the ownership is not transferred
        */
        CSIPIetfProfileContext* FindProfileContext(TUint32 aProfileId) const;

        /**
        * Finds connection context
        * @param aPriofile a profile
        * @return a connection context
        */
        CSIPIetfConnectionContext* FindConnectionContext(CSIPConcreteProfile&amp; aProfile) const;
    
        /**
        * Destroys idle connection contexts
        */
        void CleanIdleConnectionContexts();
                
        TBool DeregisterToWaitingQueueL( CSIPIetfProfileContext* aContext );
        
        void HandleRegisterQueue( CSIPIetfProfileContext* aContext, TBool aReportError );
        
        void RegisterQueue( CSIPConcreteProfile&amp; aProfile, TBool aReportError );
    
        TBool AllowedTakeFromQueue( CSIPConcreteProfile&amp; aSIPConcreteProfile );
    
    
    private: //  Data

        CSIP*                                    iSIP;
        CSIPHttpDigest*                         iHttpDigest;
        MSIPProfileAgentObserver&amp;                iSIPProfileAgentObserver;
        CDeltaTimer&amp;                            iDeltaTimer;
        TSIPProfileTypeInfo                        iType;
        CSIPPrflInitState*                        iInit;
        CSIPPrflResolvingProxiesState*            iResolvingProxies;
        CSIPPrflRegisterRequestedState*            iRegRequested;
        CSIPPrflRegistrationInProgressState*    iRegInProgress;
        CSIPPrflRegisteredState*                iRegistered;
        CSIPPrflDeregisterRequestedState*        iDeregRequested;
        CSIPPrflDeregistrationInProgressState*    iDeregInProgress;
        CSIPPrflRegisterDelayRequestedState*    iRegDelayRequested;
        RPointerArray&lt;CSIPIetfConnectionContext&gt; iConnectionCtxArray;
        CSIPProfileQueueHandling*                 iProfileQueueHandling;


#ifdef CPPUNIT_TEST    
        friend class CSIPIetfProfileAgentTest;
#endif
    };

#endif CSIPIETFPROFILEAGENT_H
</pre>
 <p><strong>sipietfprofilecontext.h</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-D4157C14-60BB-5A1F-A45A-7AA80A95A552"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-D4157C14-60BB-5A1F-A45A-7AA80A95A552"><!-- --></a>// sipietfprofilecontext.h

#ifndef SIPIETFPRROFILECONTEXT_H
#define SIPIETFPRROFILECONTEXT_H

//INCLUDES 
#include "sipprofilecontextbase.h"
#include "sipietfconnectioncontext.h"

// FORWARD DECLARATIONS
class CSIPConcreteProfile;


// CLASS DECLARATION
/**
*  Class for maintaining the information related
*  to a particular IETF type profile. Class stores
*  related registration, sip connection and transactions.
*
*  @lib n/a.
*/
class CSIPIetfProfileContext : public CSIPProfileContextBase
    {
    public:
           
        /**
        * Two-phased constructor.
        * @param aSIP a handle to SIP server
        * @param aConnection a SIP connection
        * @param aInitState a init state
        * @param aProfile a profile
        */
        static CSIPIetfProfileContext* NewL(
            CSIP&amp; aSIP,
            CSIPIetfConnectionContext&amp; aConnection,
            MSIPProfileAgentObserver&amp; aObserver,
            CSIPPrflStateBase&amp; aInitState,
            CSIPConcreteProfile&amp; aProfile,
            CDeltaTimer&amp; aDeltaTimer);
        /**
        * Two-phased constructor.
        * @param aSIP a handle to SIP server
        * @param aConnection a SIP connection
        * @param aInitState a init state
        * @param aProfile a profile
        */
        static CSIPIetfProfileContext* NewLC(
            CSIP&amp; aSIP,
            CSIPIetfConnectionContext&amp; aConnection,
            MSIPProfileAgentObserver&amp; aObserver,
            CSIPPrflStateBase&amp; aInitState,
            CSIPConcreteProfile&amp; aProfile,
            CDeltaTimer&amp; aDeltaTimer);
        /**
        * Destructor.
        */
        ~CSIPIetfProfileContext();


    public: // From MSIPProfileContext

        void DestroyRegistration();

        void CreateRegistrationL();

        CSIPMessageElements* CreateMsgElementsLC();
        
        CSIPMessageElements* CreateDeRegisterElementsL();
        
        void UpdateContactHeaderParamsL(CSIPConcreteProfile&amp; aNewProfile);
        
        void SetRegisteredAORsL();    
        
        void ResolveProxyL();
        
        void CancelProxyResolving();    
        
        
    public: // New functions

        /**
        * Deregisters SIP profile according to the profile type.
        * @param aSIPConcreteProfile sip profile to deregister
        */
        void DeregisterL();

         /**
        * Updates SIP profile. This can lead to profile de-registration
        * and registration. Function leaves with KErrArgument if profiles 
        * are the same.
        * @param aNewProfile sip profile to update
        */
        void UpdateL(CSIPConcreteProfile&amp; aNewProfile);

        /**
        * A SIP response creating a registration binding or an error response 
        * that is related to an refreshed registration binding  
        * has been received from the network.
        * @param aTransaction contains response elements.
        * The ownership is transferred.
        * @param aRegistration associated registration
        * @param aHandled, returned ETrue if response handled
        */
        void IncomingResponse(CSIPClientTransaction&amp; aTransaction,
                              CSIPRegistrationBinding&amp; aRegistration,
                              TBool&amp; aHandled);
                              
        TBool RetryTimerInUse();                      
        
        TUint DelayTime();
        TBool RetryAfterTimer();
        
    private: // Constructor
    
        CSIPIetfProfileContext(
            CSIP&amp; aSIP,
            CSIPIetfConnectionContext&amp; iConnection,
            MSIPProfileAgentObserver&amp; aObserver,
            CSIPPrflStateBase&amp; aInitState,
            CSIPConcreteProfile&amp; aProfile,
            CDeltaTimer&amp; aDeltaTimer);
            
        void ConstructL();


    private: // From CSIPProfileContextBase

        void ConnectionStateChangedImpl(CSIPConnection::TState aState);
        
        TBool RetryRegister(CSIPClientTransaction* aTransaction, 
                            TInt aError);
                             
        TBool ShouldRetryRegistration(TInt aError);                     

        void InitializeRetryTimerValue();


    private: // New functions
    
        CSIPMessageElements* CreateMsgElementsForUpdateLC(
            CSIPConcreteProfile&amp; aProfile);
        TUint RandomPercent();
        TBool IsAddressSIPSURIL(const TDesC8&amp; aValue) const;
        HBufC8* SetAddressToSIPSURIL(const TDesC8&amp; aValue);
        TBool SetTlsToSecurityClientL();
        TBool IsDynamicNumericIPAddress( const TDesC8&amp; aValue );
        TBool IsConfiguredOutboundProxySIPURIL( const TDesC8&amp; aValue );
        RStringF TransportProtocol(const CUri8&amp; aUri) const;

    private: // Data
    
        CSIPIetfConnectionContext&amp;    iConnectionContext;
        RStringF iStrNATTraversalRequired;
        TInt64                         iRandomSeed;
        TUint                          iRetryTime;
        TUint                        iRetryCounter;
        TUint                        iRetryCounterSum;
        TBool                        iRetryTimerUse;

    private: // For testing purposes

        friend class CSIPIetfProfileContextTest;
        friend class CSIPIetfConnectionContextTest;
        friend class CSIPIetfProfileAgentTest;
    };

#endif
</pre>
 <p><strong>sipietfconnectioncontext.h</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-E10EB30D-1A55-5B11-BEEB-5E01C7E525AA"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-E10EB30D-1A55-5B11-BEEB-5E01C7E525AA"><!-- --></a>// sipietfconnectioncontext.h

#ifndef    CSIPIETFCONNECTIONCONTEXT_H
#define CSIPIETFCONNECTIONCONTEXT_H

//  INCLUDES
#include &lt;e32base.h&gt;
#include &lt;bamdesca.h&gt;
#include "sipconnectionobserver.h"
#include "MSIPProxyResolverObserver.h"

// FORWARD DECLARATIONS
class CSIPIetfProfileContext;
class CSIPRegistrationBinding;
class CSIPClientTransaction;
class CSIPDialogAssocBase;
class CSIPProxyResolver;
class CSIPHttpDigest;

// CLASS DECLARATION

/**
* Class maintains associations between the SIP connection
* and related SIP profiles. 
* 
*/
class CSIPIetfConnectionContext: public CBase, public MSIPConnectionObserver,
    public MSIPProxyResolverObserver
    {
    public: // Constructors and destructor
           
        /**
        * Two-phased constructor.
        */
        static CSIPIetfConnectionContext* NewL();

        /**
        * Two-phased constructor.
        */
        static CSIPIetfConnectionContext* NewLC();

        /**
        * Destructor.
        */
        ~CSIPIetfConnectionContext();

    public://new functions

        /**
        * Gets connection, the ownership is not transferred
        * @return connection
        */
        CSIPConnection* Connection();

        /**
        * Add profile context, ownership transferred
        * @param aContext, profile context using the connection
        */
        void AddProfileContextL(CSIPIetfProfileContext* aContext);

        /**
        * Find context of the profile, the ownership is not transferred
        * @param aProfileId, profile stored in context
        */
        CSIPIetfProfileContext* FindContext(TUint32 aProfileId);

        /**
        * Delete idle contexts
        */
        void CleanIdleContexts();

        /**
        * Set connection for the context
        * @param aConnection, connection of the context
        */
        void SetConnection(CSIPConnection* aConnection);

        /**
        * Checks if connection idle
        * @return ETrue, if contains no profile contexts, otherwise EFalse
        */
        TBool IsIdle() const;

        /**
        * starts resolving proxy
        */
        void ResolveL();

        /**
        * Cleans dynamic proxy addresses and cancels any
        * pending requests
        */
        void CleanProxyResolving();
        
        /**
        * Checks if registration/deregistration should be put
        * in queue to wait, because there is registration/deregistration
        * with same registrar address pending.
        * @return ETrue if should be put into queue to wait.
        */
        TBool AddIntoQueue( const TDesC8&amp; aValue );

        /**
        * Sets HTTP Digest credentials from the profile
        * if the given transaction was found from one 
        * of the profiles related to this connection.
        * @return ETrue if the transaction was found and credentials were set.
        */
        TBool SetCredentials(
            const CSIPClientTransaction&amp; aTransaction,
            CSIPHttpDigest&amp; aDigest);

        /**
        * Sets HTTP Digest credentials from the profile
        * if the given refresh was found from one 
        * of the profiles related to this connection.
        * @return ETrue if the refresh was found and credentials were set.
        */
        TBool SetCredentials(
            const CSIPRefresh&amp; aRefresh,
            CSIPHttpDigest&amp; aDigest);

    public://functions from base class

        /**
        * A SIP request outside a dialog has been received from the network.
        * @param aTransaction SIP server transaction
        * The ownership is transferred.
        */
        void IncomingRequest (CSIPServerTransaction* 
                                      aTransaction);

        /**
        * A SIP request within a dialog has been received from the network.
        * The client must resolve the actual dialog association to which
        * this request belongs.
        * @param aTransaction SIP server transaction
        * The ownership is transferred.
        * @param aDialog the dialog  that
        *        this transaction belongs to.
         */
        void IncomingRequest (
                    CSIPServerTransaction* aTransaction,
                    CSIPDialog&amp; aDialog);

        /**
        * A SIP response received from the network.
        * @param aTransaction contains response elements.
        * The ownership is transferred.
        */
        void IncomingResponse (CSIPClientTransaction&amp; 
                                       aTransaction);

        /**
        * A SIP response that is within a dialog association or creates
        * a dialog association.
        * @param aTransaction contains response elements.
        * The ownership is transferred.
        * @param aDialogAssoc a dialog association
        */
        void IncomingResponse (
                    CSIPClientTransaction&amp; aTransaction,
                    CSIPDialogAssocBase&amp; aDialogAssoc);

        /**
        * A SIP response creating a registration binding or an error response 
        * that is related to an refreshed registration binding  
        * has been received from the network.
        * @param aTransaction contains response elements.
        * The ownership is transferred.
        * @param aSIPRegistration associated registration
        */
        void IncomingResponse (
                    CSIPClientTransaction&amp; aTransaction,
                    CSIPRegistrationBinding&amp; aRegistration);

        /**
        * A SIP response related a registration binding or an error response
        * that is related to registration binding has been received
        * from the network.
        *
        * @param aTransaction contains response elements.
        * @param aRegistration registration this transaction belongs to
        */
        void IncomingResponse (
                    CSIPClientTransaction&amp; aTransaction,
                    CSIPInviteDialogAssoc* aDialogAssoc);

        /**
        * An asynchronous error has occurred related to a periodical refresh 
        * that relates to a registration.
        * @param aError error code
        * @param aSIPRegistration associated registration
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPRegistrationBinding&amp; aRegistration);
        /**
        * An asynchronous error has occurred in the stack related
        * to the request indicated by the given transaction.
        * @param aError error code
        * @param aTransaction the failed transaction
        * @param aRegistration the failed registration
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPClientTransaction&amp; aTransaction,
                    CSIPRegistrationBinding&amp; aRegistration);

        /**
        * An asynchronous error has occurred in the stack related to the
        * request indicated by the given transaction.
        * @param aError error code
        * @param aTransaction failed transaction
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPTransactionBase&amp; aTransaction);
    
        /**
        * An asynchronous error has occured related to a request within
        * an existing dialog.
        * @param aError error code
        * @param aTransaction the failed transaction
        * @param aDialogAssoc the failed dialog association
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPTransactionBase&amp; aTransaction,
                    CSIPDialogAssocBase&amp; aDialogAssoc);

        /**
        * An asynchronous error has occured related to a refresh 
        * @param aError error code
        * @param aSIPRefresh original refresh object
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPRefresh&amp; aRefresh);

        /**
        * An asynchronous error has occured related to a periodical refresh 
        * that belongs to SIP dialog association.
        * @param aError error code
        * @param aDialogAssoc SIP dialog association
        */
        void ErrorOccured (
                    TInt aError,
                    CSIPDialogAssocBase&amp; aDialogAssoc);

        /**
        * Connection state has changed.
        * @param aState indicates the current connection state
        */
        void ConnectionStateChanged (
                    CSIPConnection::TState aState);

        /**
        * SIP stack has completed UAC core INVITE transaction 64*T1 seconds
        * after the reception of the first 2xx response. No more 2xx responses
        * can be received to the issued single INVITE.
        *
        * @param aTransaction a complete UAC core INVITE transaction
        */
        void InviteCompleted (CSIPClientTransaction&amp; aTransaction);
        
        /**
        * Invite was cancelled with the CANCEL
        * @param aTransaction a cancelled INVITE UAS transaction
        */
        void InviteCanceled (CSIPServerTransaction&amp; aTransaction);


        /**
        * An asynchronous proxy resolving request has been completed.
        * @param aRequestId the id of the resolving request.
        * @param aProxies a list of proxy addresses.
        *        The ownership is transferred.
        */
        void ProxyResolvingRequestComplete (TUint aRequestId,
                                                MDesC8Array* aProxies);

        /**
        * An asynchronous proxy resolving request has failed.
        * @param aRequestId the id of the resolving request.
        * @param aError a reason why the request failed.
        */
        void ProxyResolvingRequestFailed (TUint aRequestId, TInt aError);

        /**
        * starts resolving proxy
        */
        void ResolveProxyL();

    private:
        /**
        * Default constructor.
        */
        CSIPIetfConnectionContext();

        /**
        * By default Symbian 2nd phase constructor is private.
        */
        void ConstructL();


    private:
        CSIPConnection* iConnection;

        CSIPProxyResolver* iProxyResolver;
        TUint iProxyResolveRequestId;

        RPointerArray&lt;CSIPIetfProfileContext&gt; iContexts;

        friend class CSIPIetfProfileContextTest;
        friend class CSIPIetfConnectionContextTest;
    };

#endif
</pre>
 <p><strong>sipietfprofileagent.cpp</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-19595041-A37A-542A-A969-D7E4B4FCCF16"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-19595041-A37A-542A-A969-D7E4B4FCCF16"><!-- --></a>//sipietfprofileagent.cpp

// INCLUDE FILES
#include    "sipietfprofileagent.h"
#include    "sipconcreteprofile.h"
#include    "sipprofileagentobserver.h"
#include    "sipconnection.h"
#include    "sipprflinitstate.h"
#include    "sipprflresolvingproxiesstate.h"
#include    "sipprflregisterrequestedstate.h"
#include    "sipprflregisterdelayrequestedstate.h"
#include    "sipprflregistrationinprogressstate.h"
#include    "sipprflregisteredstate.h"
#include    "sipprflderegistrationinprogressstate.h"
#include    "sipprflderegisterrequestedstate.h"
#include    "sipprflstatebase.h"
#include    "sipietfprofilecontext.h"
#include    "sipgendefs.h"
#include    "SipProfileLog.h"
#include    "sipstrings.h"
#include    "sipstrconsts.h"
#include    "sipprofilequeuehandling.h"
#include    "sip.h"
#include    "siphttpdigest.h"
#include    "sipservertransaction.h"
#include    &lt;sipprofile.h&gt;

_LIT8(KSIPIETFProfileType, "IETF");

// ============================ MEMBER FUNCTIONS ===============================

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::NewL
// Two-phased constructor.
// -----------------------------------------------------------------------------
//
CSIPIetfProfileAgent* CSIPIetfProfileAgent::NewL(TAny* aInitParams)
    {
    CSIPIetfProfileAgent* self = new (ELeave) CSIPIetfProfileAgent(
        static_cast&lt;TSIPProfileAgentInitParams*&gt;(aInitParams));
    CleanupStack::PushL(self);
    self-&gt;ConstructL();
    CleanupStack::Pop(self);
    return self;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::CSIPIetfProfileAgent
// C++ default constructor can NOT contain any code, that
// might leave.
// -----------------------------------------------------------------------------
//
CSIPIetfProfileAgent::CSIPIetfProfileAgent(TSIPProfileAgentInitParams* aInitParams)
    : iSIPProfileAgentObserver(aInitParams-&gt;iSIPProfileAgentObserver),
      iDeltaTimer(aInitParams-&gt;iDeltaTimer)
    {
    iType.iSIPProfileClass = TSIPProfileTypeInfo::EInternet;
    iType.iSIPProfileName = KSIPIetfType();
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ConstructL
// Symbian 2nd phase constructor can leave.
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::ConstructL()
    {
    SIPStrings::OpenL();
    iInit = CSIPPrflInitState::NewL(*this);
    iResolvingProxies = CSIPPrflResolvingProxiesState::NewL(*this);
    iRegRequested = CSIPPrflRegisterRequestedState::NewL(*this);
    iRegInProgress = CSIPPrflRegistrationInProgressState::NewL(*this);
    iRegistered = CSIPPrflRegisteredState::NewL(*this);
    iDeregRequested = CSIPPrflDeregisterRequestedState::NewL(*this);
    iDeregInProgress = CSIPPrflDeregistrationInProgressState::NewL(*this);
    iRegDelayRequested = CSIPPrflRegisterDelayRequestedState::NewL(*this);
    iInit-&gt;LinkStates(*iResolvingProxies, *iRegRequested, *iRegInProgress);
    iResolvingProxies-&gt;LinkStates(*iInit, *iRegRequested, *iRegInProgress);
    iRegRequested-&gt;LinkStates(*iInit, *iResolvingProxies, *iRegInProgress);
    iRegInProgress-&gt;LinkStates(*iRegRequested, *iInit, *iRegistered,
                               *iRegDelayRequested);
    iRegistered-&gt;LinkStates(*iDeregRequested, *iDeregInProgress,
                             *iInit, *iRegRequested,*iRegDelayRequested);
    iDeregRequested-&gt;LinkStates(*iInit, *iRegistered, *iDeregInProgress);
    iDeregInProgress-&gt;LinkStates(*iInit);
    iRegDelayRequested-&gt;LinkStates(*iInit);
    iProfileQueueHandling = CSIPProfileQueueHandling::NewL(*this);
    
    iSIP = CSIP::NewL(TUid::Null(),*this);
    iHttpDigest = CSIPHttpDigest::NewL(*iSIP,*this);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::~CSIPIetfProfileAgent
// Symbian 2nd phase constructor can leave.
// -----------------------------------------------------------------------------
//
CSIPIetfProfileAgent::~CSIPIetfProfileAgent()
    {
    delete iInit;
    delete iResolvingProxies;
    delete iRegRequested;
    delete iRegistered;
    delete iRegInProgress;
    delete iDeregRequested;
    delete iDeregInProgress;
    delete iRegDelayRequested;
    delete iProfileQueueHandling;
    iConnectionCtxArray.ResetAndDestroy();
    iConnectionCtxArray.Close();
    SIPStrings::Close();
    delete iHttpDigest;
    delete iSIP;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::SIPProfileAgentType
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
const TSIPProfileTypeInfo&amp; CSIPIetfProfileAgent::Type() const
    {
    return iType;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::CreateL
// -----------------------------------------------------------------------------
//
CSIPConcreteProfile* CSIPIetfProfileAgent::CreateL()
    {
    TSIPProfileTypeInfo type;        
    type.iSIPProfileClass = TSIPProfileTypeInfo::EInternet;
    type.iSIPProfileName = KSIPIETFProfileType;

    CSIPConcreteProfile* profile = CSIPConcreteProfile::NewL();
    profile-&gt;SetProfileType(type);
    return profile;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RegisterL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::RegisterL(
    CSIPConcreteProfile&amp; aSIPConcreteProfile)
    {
    __ASSERT_ALWAYS (aSIPConcreteProfile.AOR().Length() &gt; 0, 
        User::Leave(KErrArgument));
    __ASSERT_ALWAYS (aSIPConcreteProfile.Server(KSIPRegistrar).Length(),
        User::Leave(KErrArgument));

    PROFILE_DEBUG3("CSIPIetfProfileAgent::RegisterL", aSIPConcreteProfile.Id())
    
    if (!iProfileQueueHandling-&gt;AddRegisterToQueueL( aSIPConcreteProfile, 
                                                     EFalse ))
        {
        CSIPIetfProfileContext* context = FindProfileContext(aSIPConcreteProfile);
        if (!context)
            {
            context = &amp;ProvideProfileContextL(aSIPConcreteProfile);
            }        
        context-&gt;RegisterL();
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::UpdateL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::UpdateL(
    CSIPConcreteProfile&amp; aNewProfile, 
    CSIPConcreteProfile&amp; aOldProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::UpdateL", aOldProfile.Id())
    iProfileQueueHandling-&gt;Cleanup(aOldProfile,&amp;aNewProfile);
    CSIPIetfProfileContext* context = FindProfileContext(aOldProfile);
    if (!context)
        {
        User::Leave(KErrNotFound);
        }
    context-&gt;UpdateL(aNewProfile);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::DeregisterL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::DeregisterL(
    CSIPConcreteProfile&amp; aSIPConcreteProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::DeregisterL", aSIPConcreteProfile.Id())
    CSIPIetfProfileContext* context = FindProfileContext(aSIPConcreteProfile);
    if ( context )
        {
        if ( !DeregisterToWaitingQueueL( context ))
            {
            context-&gt;DeregisterL();
            }
        }
    else
        {
        iProfileQueueHandling-&gt;RemoveProfileFromRegQueueL(aSIPConcreteProfile);
        }     
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::GetProfileState
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TInt CSIPIetfProfileAgent::GetProfileState(
    CSIPConcreteProfile::TStatus&amp; aState, 
    CSIPConcreteProfile&amp; aProfile) const
    {
    CSIPIetfProfileContext* context = FindProfileContext(aProfile);
    if (context)
        {
        aState = context-&gt;CurrentMappedState();
        return KErrNone;
        }
    else
        {
        return KErrNotFound;
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::IsIdle
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileAgent::IsIdle()
    {
    CleanIdleConnectionContexts();
    return (iConnectionCtxArray.Count()==0);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RegisterPending
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileAgent::RegisterPending(
    CSIPConcreteProfile&amp; aSIPProfile) const
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::IsRegisterPending", aSIPProfile.Id()) 
    
    CSIPIetfProfileContext* context = FindProfileContext(aSIPProfile);
    if (context)
        {
        return context-&gt;IsRegisterPending();
        }
    return EFalse;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::TerminateHandling
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TInt CSIPIetfProfileAgent::TerminateHandling(CSIPConcreteProfile&amp; aProfile)
    {
    CSIPIetfProfileContext* context = FindProfileContext(aProfile);
    if (context)
        {
        PROFILE_DEBUG3("CSIPIetfProfileAgent::TerminateHandling", aProfile.Id())
        context-&gt;SetNextState(*iInit);
        context-&gt;TerminateHandling();
        return KErrNone;
        }
    else
        {
        return KErrNotFound;
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::Extension
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TInt CSIPIetfProfileAgent::Extension(TInt /*aOperationCode*/, TAny* /*aParams*/)
    {
    return KErrNotSupported;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::SIPProfileStatusEvent
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::SIPProfileStatusEvent(
    CSIPConcreteProfile&amp; aProfile,
    TUint32 aContextId)
    {
    PROFILE_DEBUG4("CSIPIetfProfileAgent::SIPProfileStatusEvent",\
        aProfile.Id(), aContextId)
        
    CSIPIetfProfileContext* context = FindProfileContext( aProfile.Id() );
    
    HandleRegisterQueue( context, ETrue );
    
    iSIPProfileAgentObserver.SIPProfileStatusEvent( aProfile, aContextId );
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::SIPProfileErrorEvent
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::SIPProfileErrorEvent(
    CSIPConcreteProfile&amp; aProfile,
    TInt aError)
    {
    PROFILE_DEBUG4("CSIPIetfProfileAgent::ErrorEvent", aProfile.Id(), aError)
    CSIPIetfProfileContext* context = FindProfileContext(aProfile.Id());

    if (context &amp;&amp; context-&gt;IgnoreErrorEvent())
        {
        PROFILE_DEBUG4("CSIPIetfProfileAgent::Error ignored",\
                       aProfile.Id(), aError)    
        }
    else
        {
        PROFILE_DEBUG4("CSIPIetfProfileAgent::Error sent", 
                       aProfile.Id(), aError)
            
        RegisterQueue( aProfile, EFalse );
            
        iSIPProfileAgentObserver.SIPProfileErrorEvent(aProfile,aError);
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ProceedRegistration
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileAgent::ProceedRegistration(
    CSIPConcreteProfile&amp; aProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::ProceedRegistration", aProfile.Id())
    return iSIPProfileAgentObserver.ProceedRegistration(aProfile);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::GetFailedProfilesL
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::GetFailedProfilesL(
    const TSIPProfileTypeInfo&amp; /*aType*/,
    RPointerArray&lt;CSIPConcreteProfile&gt;&amp; /*aFailedProfiles*/) const
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RegisterProfileL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//    
void CSIPIetfProfileAgent::RegisterProfileL(
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    RegisterL(aSIPProfile);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::DeregisterProfileL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::DeregisterProfileL(
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    DeregisterL(aSIPProfile);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RetryProfileRegistrationL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::RetryProfileRegistrationL( 
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::RetryProfileRegistrationL", 
                   aSIPProfile.Id())

    if (!iProfileQueueHandling-&gt;AddRegisterToQueueL(aSIPProfile, ETrue))
        {
        CSIPIetfProfileContext* context = FindProfileContext(aSIPProfile);
        if (!context)
            {
            User::Leave(KErrNotFound);
            }        
        context-&gt;RetryRegistration();
        }    
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::AddProfileIntoQueue
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileAgent::AddProfileIntoQueue(
    CSIPConcreteProfile&amp; aSIPProfile) const
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::AddProfileIntoQueue", 
                   aSIPProfile.Id())
    
    TBool found = EFalse;
    for (TInt i=0; i &lt; iConnectionCtxArray.Count() &amp;&amp; !found; i++)
        {
        found = iConnectionCtxArray[i]-&gt;AddIntoQueue(
            aSIPProfile.Server(KSIPRegistrar));
        }
    return found;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RegisterProfileAfterQueueL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::RegisterProfileAfterQueueL(
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::RegisterProfileAfterQueueL", 
                   aSIPProfile.Id())    
    
    CSIPIetfProfileContext* context = FindProfileContext(aSIPProfile);
    if (!context)
        {
        context = &amp;ProvideProfileContextL(aSIPProfile);
        } 
    context-&gt;RegisterL();   
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::DeregisterProfileAfterQueueL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::DeregisterProfileAfterQueueL(
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::DeregisterProfileAfterQueueL", 
                   aSIPProfile.Id())    
    
    CSIPIetfProfileContext* context = FindProfileContext(aSIPProfile);
    __ASSERT_ALWAYS(context != NULL, User::Leave(KErrNotFound));
    context-&gt;DeregisterL();
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RetryProfileRegistrationAfterQueueL
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::RetryProfileRegistrationAfterQueueL(
    CSIPConcreteProfile&amp; aSIPProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::RetryProfileRegistrationAfterQueueL", 
                   aSIPProfile.Id())    
    
    CSIPIetfProfileContext* context = FindProfileContext(aSIPProfile);
    __ASSERT_ALWAYS(context != NULL, User::Leave(KErrNotFound));
    context-&gt;RetryRegistration();   
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::IsInQueue
// From MSIPProfileFSMUser
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileAgent::IsInQueue(
    CSIPConcreteProfile&amp; aSIPProfile) const
    {
    PROFILE_DEBUG1("CSIPIetfProfileAgent::IsInQueue")
    PROFILE_DEBUG3("CSIPIetfProfileAgent::IsInQueue", 
                   aSIPProfile.Id())    
    return iProfileQueueHandling-&gt;IsInQueue(aSIPProfile);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::SetInterimProfile
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::SetInterimProfile( CSIPConcreteProfile* /*aSIPConcreteProfile*/ )
    {

    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::IncomingRequest
// From MSIPObserver
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::IncomingRequest(
    TUint32 /*aIapId*/,
    CSIPServerTransaction* aTransaction)
    {
    // Should not be called, because CSIP is created with a NULL UID
    // Delete the transaction to prevent a memory leak
    delete aTransaction;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::TimedOut
// From MSIPObserver
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::TimedOut(CSIPServerTransaction&amp; /*aTransaction*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ChallengeReceived
// From MSIPHttpDigestChallengeObserver2
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::ChallengeReceived(
    const CSIPClientTransaction&amp; aTransaction)
    {
    TBool found = EFalse;
    for (TInt i=0; i &lt; iConnectionCtxArray.Count() &amp;&amp; !found; i++)
        {
        found = 
            iConnectionCtxArray[i]-&gt;SetCredentials(aTransaction,*iHttpDigest);
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ChallengeReceived
// From MSIPHttpDigestChallengeObserver2
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::ChallengeReceived(const CSIPRefresh&amp; aRefresh)
    {
    TBool found = EFalse;
    for (TInt i=0; i &lt; iConnectionCtxArray.Count() &amp;&amp; !found; i++)
        {
        found = iConnectionCtxArray[i]-&gt;SetCredentials(aRefresh,*iHttpDigest);
        }
    }

// ----------------------------------------------------------------------------
// CSIPIetfProfileAgent::HandleRegisterQueue
// ----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::HandleRegisterQueue( 
    CSIPIetfProfileContext* aContext,
    TBool aReportError )
    {
    PROFILE_DEBUG1("CSIPIetfProfileAgent::HandleRegisterQueue") 
    
    if ( !aContext || !aContext-&gt;Profile() )
        {
        return;
        }
    
       RegisterQueue( *aContext-&gt;Profile(), aReportError );
    }
        
// ----------------------------------------------------------------------------
// CSIPIetfProfileAgent::RegisterQueue
// ----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::RegisterQueue( 
    CSIPConcreteProfile&amp; aProfile,
    TBool aReportError )
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::RegisterQueue", aProfile.Id())    

    TInt err( KErrNone );
    
    if ( AllowedTakeFromQueue( aProfile ) )
        {
        TRAP( err, iProfileQueueHandling-&gt;RegisterFromQueueL( aProfile ) );
        }
        
    if ( err &amp;&amp; aReportError )
        {
        iSIPProfileAgentObserver.SIPProfileErrorEvent( aProfile, err );
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::AllowedTakeFromQueue
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileAgent::AllowedTakeFromQueue(
    CSIPConcreteProfile&amp; aSIPConcreteProfile )
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::AllowedTakeFromQueueL", 
                   aSIPConcreteProfile.Id())     

    return !AddProfileIntoQueue( aSIPConcreteProfile );
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::DeregisterToWaitingQueueL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileAgent::DeregisterToWaitingQueueL( 
    CSIPIetfProfileContext* aContext )
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::DeregisterToWaitingQueueL", 
                   aContext-&gt;Profile()-&gt;Id())
                   
    if (!aContext-&gt;AddDeregisterIntoQueue())
        {
        return EFalse;
        }
    return iProfileQueueHandling-&gt;AddDeregisterToQueueL( *aContext-&gt;Profile() );
    }    

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::FindProfileContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext* CSIPIetfProfileAgent::FindProfileContext(
    CSIPConcreteProfile&amp; aSIPConcreteProfile) const
    {
    return FindProfileContext(aSIPConcreteProfile.Id());
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::FindProfileContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext* CSIPIetfProfileAgent::FindProfileContext(
    TUint32 aProfileId) const
    {
    for (TInt i=0; i &lt; iConnectionCtxArray.Count(); i++)
        {
        CSIPIetfProfileContext *context = 
            iConnectionCtxArray[i]-&gt;FindContext(aProfileId);
        if (context)
            {
            return context;
            }
        }
    return 0;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::FindConnectionContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfConnectionContext* CSIPIetfProfileAgent::FindConnectionContext(
    CSIPConcreteProfile&amp; aProfile) const
    {
    CSIPIetfConnectionContext* context =0;
    TBool found = EFalse;
    for (TInt i=0; i &lt; iConnectionCtxArray.Count() &amp;&amp; !found; i++)
        {
        if (iConnectionCtxArray[i]-&gt;Connection()-&gt;IapId() == aProfile.IapId())
            {
            context = iConnectionCtxArray[i];
            found = ETrue;
            }
        }
    return context;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ProvideContextL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext&amp; CSIPIetfProfileAgent::ProvideProfileContextL(
    CSIPConcreteProfile&amp; aProfile)
    {
    PROFILE_DEBUG3("CSIPIetfProfileAgent::ProvideProfileContextL", 
                   aProfile.Id())
    
    CSIPIetfConnectionContext* connContext = FindConnectionContext(aProfile);
    if (!connContext)
        {
        //must create connection first
        connContext = CSIPIetfConnectionContext::NewLC();
        CSIPConnection* connection = CSIPConnection::NewL(
            *iSIP, aProfile.IapId(), *connContext);
        connContext-&gt;SetConnection(connection);
        User::LeaveIfError(iConnectionCtxArray.Append(connContext));
        CleanupStack::Pop();//connContext
        }
    CSIPIetfProfileContext* profilectx = CSIPIetfProfileContext::NewLC(
        *iSIP, *connContext, *this,
        *iInit, aProfile, iDeltaTimer);
    connContext-&gt;AddProfileContextL(profilectx);
    CleanupStack::Pop();//profilectx 
    return *profilectx;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileAgent::ProvideContextL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileAgent::CleanIdleConnectionContexts()
    {
    CSIPIetfConnectionContext* context = 0;

    for (TInt i=iConnectionCtxArray.Count()-1; i&gt;= 0;)
        {
        iConnectionCtxArray[i]-&gt;CleanIdleContexts();
        if (iConnectionCtxArray[i]-&gt;IsIdle())
            {
            PROFILE_DEBUG1("CSIPIetfProfileAgent::CleanIdleConnectionContexts,\
                ConnectionContext removed")
            context = iConnectionCtxArray[i];
            iConnectionCtxArray.Remove(i);
            delete context;
            context = NULL;
            }
        i--;
        }
        
    iConnectionCtxArray.Compress();
    }
</pre>
 <p><strong>Sipietfprofilecontext.cpp</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-65EB1A9E-9393-504D-B9FE-4912C9085CC9"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-65EB1A9E-9393-504D-B9FE-4912C9085CC9"><!-- --></a>//Sipietfprofilecontext.cpp


// INCLUDE FILES
#include "sipietfprofilecontext.h"
#include "sipprflstatebase.h"
#include "sipconcreteprofile.h"
#include "sipietfprofileagent.h"
#include "sipregistrationbinding.h"
#include "sipclienttransaction.h"
#include "siprouteheader.h"
#include "sipgendefs.h"
#include "siprefresh.h"
#include "sipmessagebuilder.h"
#include "sipaddress.h"
#include "siptoheader.h"
#include "siprouteheader.h"
#include "sipmessageelements.h"
#include "sipresponseelements.h"
#include "sipsecurityclientheader.h"
#include "sipconnection.h"
#include "SipProfileLog.h"
#include "sipstrings.h"
#include "sipstrconsts.h"
#include "siperr.h"
#include "sipcodecerr.h"
#include "sipcontactheader.h"
#include &lt;sipprofile.h&gt;
#include &lt;bamdesca.h&gt;
#include &lt;e32math.h&gt;
#include &lt;uri8.h&gt;
#include &lt;uriutils.h&gt;

_LIT8(KNATTraversalRequiredDes, "nat_traversal_required");
_LIT8(KSIPTls, "tls");
_LIT8(KTransportUdpParam, "transport=udp");
_LIT8(KTransportTcpParam, "transport=tcp");

const TUint KMaxRandomLimit = 50;
const TUint KBaseTimeInSec    = 30;
const TUint KWaitTimeCoefficient = 2;
const TUint KRandomDivider        = 100;
const TUint KMaxRetryForOneAddress = 9;

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::NewLC
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext* CSIPIetfProfileContext::NewLC(
    CSIP&amp; aSIP,
    CSIPIetfConnectionContext&amp; aConnection, 
    MSIPProfileAgentObserver&amp; aObserver,
    CSIPPrflStateBase&amp; aInitState,
    CSIPConcreteProfile&amp; aProfile,
    CDeltaTimer&amp; aDeltaTimer)
    {
    CSIPIetfProfileContext* self = new (ELeave) CSIPIetfProfileContext(aSIP,
        aConnection, aObserver, aInitState, aProfile, aDeltaTimer);
    CleanupStack::PushL(self);
    self-&gt;ConstructL();
    return self;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::NewL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext* CSIPIetfProfileContext::NewL(
    CSIP&amp; aSIP,
    CSIPIetfConnectionContext&amp; aConnection, 
    MSIPProfileAgentObserver&amp; aObserver,
    CSIPPrflStateBase&amp; aInitState,
    CSIPConcreteProfile&amp; aProfile,
    CDeltaTimer&amp; aDeltaTimer)
    {
    CSIPIetfProfileContext* self = CSIPIetfProfileContext::NewLC(
        aSIP, aConnection, aObserver, aInitState, aProfile, aDeltaTimer);
    CleanupStack::Pop();
    return self;
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CSIPIetfProfileContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext::CSIPIetfProfileContext(
    CSIP&amp; aSIP,
    CSIPIetfConnectionContext&amp; aConnection,
    MSIPProfileAgentObserver&amp; aObserver,
    CSIPPrflStateBase&amp; aInitState,
    CSIPConcreteProfile&amp; aProfile,
    CDeltaTimer&amp; aDeltaTimer)
    : CSIPProfileContextBase(aSIP,
                             *(aConnection.Connection()),
                             aObserver,
                             aInitState,
                             aProfile,
                             aDeltaTimer),
      iConnectionContext(aConnection),
      iRetryTimerUse(EFalse)
    {
    iRandomSeed = 0;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::ConstructL
// -----------------------------------------------------------------------------
//    
void CSIPIetfProfileContext::ConstructL()
    {
    iStrNATTraversalRequired = 
        SIPStrings::Pool().OpenFStringL(KNATTraversalRequiredDes);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::~CSIPIetfProfileContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext::~CSIPIetfProfileContext()
    {
    iStrNATTraversalRequired.Close();
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::DestroyRegistration()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::DestroyRegistration()
    {
    PROFILE_DEBUG3("SIPIetfProfileContext::DestroyRegistration", iProfileId)
    delete iRegistration;
    iRegistration = 0;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CreateRegistrationL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::CreateRegistrationL()
    {
    ASSERT(iProfile);
    RStringF transport(SIPStrings::StringF(SipStrConsts::EEmpty));
    CleanupClosePushL(transport);
    CSIPRouteHeader* proxy = 0;
    CUri8* remoteUri = 0;
    CSIPRefresh* refresh = CSIPRefresh::NewLC();
    CSIPToHeader* to = SIPMessageBuilder::CreateToLC(iProfile-&gt;AOR());
    to-&gt;SetParamL(iStrNATTraversalRequired);
    TUint pops = 2; //initial amount to pop from CleanupStack
    
    const TDesC8&amp; proxyAddr = ProxyAddressL();
    HBufC8* sipsproxy = NULL;
    if(IsAddressSIPSURIL(iProfile-&gt;AOR()) &amp;&amp; proxyAddr.Length() &gt; 0)
        {
        if (!IsProxyResolvingEnabled())
            {
            __ASSERT_ALWAYS (IsAddressSIPSURIL(proxyAddr), 
                        User::Leave(KErrArgument));
            }
        else
            {
            sipsproxy = SetAddressToSIPSURIL(proxyAddr);
            CleanupStack::PushL(sipsproxy);
            pops++;
            }
        __ASSERT_ALWAYS (!iProfile-&gt;IsSecurityNegotiationEnabled(), 
                    User::Leave(KErrArgument));    
        }
        
    if (!sipsproxy)
        {
        sipsproxy = proxyAddr.AllocLC();
        pops++;
        }

    if (sipsproxy-&gt;Length()) //there is an outbound proxy defined
        {
        (iProfile-&gt;IsSigCompEnabled())?
        proxy = SIPMessageBuilder::CreateRouteLC(*sipsproxy, ETrue):
        proxy = SIPMessageBuilder::CreateRouteLC(*sipsproxy);
        pops++;
        RStringF proxyTransport = TransportProtocol(proxy-&gt;SIPAddress().Uri8());    
        if (proxyTransport.DesC().Length() &gt; 0)
            {
            transport = proxyTransport.Copy();
            }        
        }
        
    if (iProfile-&gt;Server(KSIPRegistrar).Length()) //there's a registrar defined
        {
        TUriParser8 parser;
        User::LeaveIfError(parser.Parse(iProfile-&gt;Server(KSIPRegistrar)));
        remoteUri = CUri8::NewLC(parser);            
        pops++;
        if (!proxy)
            {
            RStringF registrarTransport = TransportProtocol(*remoteUri);        
            if (registrarTransport.DesC().Length() &gt; 0)
                {
                transport = registrarTransport.Copy();
                }
            }
        }        

    TBool sigcomp = iProfile-&gt;IsSigCompEnabled();
    
    const TDesC8* user = NULL;
    User::LeaveIfError(
        iProfile-&gt;ExtensionParameter(KSIPContactHeaderUser,user));
    
    CSIPContactHeader* contact =
        SIPMessageBuilder::CreateContactLC(*user, KSIPIetfExpiresValue,
                                           iProfile-&gt;ContactHeaderParams(),
                                           transport, sigcomp);
    pops++;

    if (IsAddressSIPSURIL(iProfile-&gt;AOR()))
        {
        CUri8* contactUriClone = 
            CUri8::NewLC(contact-&gt;SIPAddress()-&gt;Uri8().Uri());
        contactUriClone-&gt;SetComponentL(
            SIPStrings::StringF(SipStrConsts::ESips).DesC(),EUriScheme);
        contactUriClone-&gt;SetComponentL(*user,EUriUserinfo);                
        contact-&gt;SIPAddress()-&gt;SetUri8L(contactUriClone);
        CleanupStack::Pop(contactUriClone);
        }
    
    iRegistration = CSIPRegistrationBinding::NewL(iConnection, to, contact,
                                                  refresh, proxy, remoteUri);
    CleanupStack::Pop(pops);
    delete sipsproxy;
    CleanupStack::PopAndDestroy(1); // transport
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CreateMsgElementsLC()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPMessageElements* CSIPIetfProfileContext::CreateMsgElementsLC()
    {
    ASSERT(iProfile);
    
    CSIPMessageElements* elements = CSIPMessageElements::NewLC();
    
    RPointerArray&lt;CSIPHeaderBase&gt; headers;
    CSIPHeaderBase::PushLC(&amp;headers);
    if (SetTlsToSecurityClientL())
        {
        CSIPSecurityClientHeader* sclient = 
            CSIPSecurityClientHeader::NewLC(KSIPTls);
        headers.AppendL(sclient);
        CleanupStack::Pop(sclient);
        }
        
    if (iProfile-&gt;IsSecurityNegotiationEnabled())
        {
        CSIPSecurityClientHeader* sclient = 
            CSIPSecurityClientHeader::NewLC(KSIPdigest);
        headers.AppendL(sclient);
        CleanupStack::Pop(sclient);
        }
        
    TInt sipHeaderCount = iProfile-&gt;SIPHeaders().MdcaCount();
    for (TInt i=0; i &lt; sipHeaderCount; i++)
        {
        TPtrC8 headerDes(iProfile-&gt;SIPHeaders().MdcaPoint(i));
        CSIPHeaderBase* header = SIPMessageBuilder::CreateHeaderLC(headerDes);
        headers.AppendL(header);
        CleanupStack::Pop(header);
        }   
    
    elements-&gt;SetUserHeadersL(headers); // // An empty array is also allowed
    CleanupStack::Pop(1); // headers
        
    return elements;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CreateDeRegisterElementsL()
// -----------------------------------------------------------------------------
//    
CSIPMessageElements* CSIPIetfProfileContext::CreateDeRegisterElementsL()
    {
    return NULL;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::UpdateContactHeaderParamsL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::UpdateContactHeaderParamsL(
    CSIPConcreteProfile&amp; aNewProfile)
    {
    CSIPContactHeader&amp; contact = Registration()-&gt;ContactHeader();
    TPtrC8 paramName;
    TPtrC8 paramValue;

    for (TInt i = Profile()-&gt;ContactHeaderParams().MdcaCount()-1;i &gt;= 0; i--)
        {
        TPtrC8 param(Profile()-&gt;ContactHeaderParams().MdcaPoint(i));
        SIPMessageBuilder::ParseParamL(param,paramName,paramValue);        
        RStringF name = SIPStrings::Pool().OpenFStringL(paramName);
        CleanupClosePushL(name);
        contact.DeleteParam(name);
        CleanupStack::PopAndDestroy(1); // name
        }

    for (TInt i = 0; &amp;(aNewProfile.ContactHeaderParams()) &amp;&amp; 
                     (i &lt; aNewProfile.ContactHeaderParams().MdcaCount()); i++)
        {
        TPtrC8 param(aNewProfile.ContactHeaderParams().MdcaPoint(i));
        TBool hasValue = 
            SIPMessageBuilder::ParseParamL(param,paramName,paramValue);
        RStringF name = SIPStrings::Pool().OpenFStringL(paramName);
        CleanupClosePushL(name);
        if (hasValue)
            {
            RStringF value = SIPStrings::Pool().OpenFStringL(paramValue);
            CleanupClosePushL(value);
            contact.SetParamL(name,value);
            CleanupStack::PopAndDestroy(1); // value
            }
        else
            {
            contact.SetParamL(name);    
            }
        CleanupStack::PopAndDestroy(1); // name    
        }
    
    CSIPMessageElements* elements = CreateMsgElementsForUpdateLC(aNewProfile);
    SetTransaction(Registration()-&gt;UpdateL(KSIPIetfExpiresValue, elements));
    CleanupStack::Pop(elements);
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::SetRegisteredAORsL()
// -----------------------------------------------------------------------------
//    
void CSIPIetfProfileContext::SetRegisteredAORsL()
    {
    if (iProfile)
        {
        CDesC8ArrayFlat* array = new(ELeave)CDesC8ArrayFlat(1);
        CleanupStack::PushL(array);    
        array-&gt;AppendL(iProfile-&gt;AOR());
        iProfile-&gt;SetRegisteredAORsL(*array);
        CleanupStack::PopAndDestroy(array);
        if (iRegistration &amp;&amp; iRegistration-&gt;RegisteredContact())
            {
            HBufC8* contact = 
                iRegistration-&gt;RegisteredContact()-&gt;ToTextValueLC();
            iProfile-&gt;SetExtensionParameterL(KSIPRegisteredContact,*contact);
            CleanupStack::PopAndDestroy(contact);
            }
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::ResolveProxyL
// -----------------------------------------------------------------------------
//    
void CSIPIetfProfileContext::ResolveProxyL()
    {
    iConnectionContext.ResolveL();
    }
       
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CancelProxyResolving
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::CancelProxyResolving()
    {
    iConnectionContext.CleanProxyResolving();
    }    

// -----------------------------------------------------------------------------

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::RetryAfterTimer
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileContext::RetryAfterTimer()
    {
    return ( iRetryCounterSum == 0 &amp;&amp; iRetryTimerUse );
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::RetryRegister
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileContext::RetryRegister( 
    CSIPClientTransaction* /*aTransaction*/,
    TInt aError )
    {
    PROFILE_DEBUG4("CSIPIetfProfileContext::RetryRegister",
                   aError, iRetryCounterSum)

    TBool retry = EFalse;
        
    if (iProfile &amp;&amp;
        AgentObserver().ProceedRegistration(*iProfile) &amp;&amp;
        (CurrentState() == MSIPProfileContext::ERegistrationInProgress ||
         CurrentState() == MSIPProfileContext::ERegistered) &amp;&amp;
        (aError == KErrSIPOutboundProxyNotResponding || 
         aError == KErrSIPResolvingFailure || 
         aError == KErrTimedOut || 
         aError == KErrSIPTransportFailure &amp;&amp; 
         iConnection.State() != CSIPConnection::ESuspended))        
        {
        if ( iRetryCounterSum + 1 &lt; KMaxRetryForOneAddress &amp;&amp;
             iRetryCounter &lt; KMaxRetryForOneAddress )
            {
            retry = ETrue;
            }
        else
            {
            if (iRetryCounterSum &lt; KMaxRetryForOneAddress &amp;&amp; 
                iRetryCounter + 1 &gt;= KMaxRetryForOneAddress ||
                iRetryCounter &gt;=  KMaxRetryForOneAddress)
                {
                iRetryCounter = 0;
                retry = RetryPossible(aError);
                }
            else
                {
                retry = ETrue;
                }
            }
        iRetryTimerUse = retry;
        SetRetryPossible(retry);
        }
    else
        {
        iRetryCounter = 0;
        iRetryCounterSum = 0;
        iRetryTimerUse = EFalse;
        }
    if (!retry)
        {
        iRetryCounter = 0;
        iRetryCounterSum = 0;
        }
    return retry;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::ShouldRetryRegistration
// -----------------------------------------------------------------------------
//    
TBool CSIPIetfProfileContext::ShouldRetryRegistration( TInt aError )
    {
    return (aError == K503ServiceUnavailable || 
            aError == KErrSIPOutboundProxyNotResponding || 
            aError == KErrTimedOut ||
            ((aError == KErrSIPResolvingFailure || 
              aError == KErrSIPTransportFailure) &amp;&amp; 
             iConnection.State() != CSIPConnection::ESuspended));
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::InitializeRetryTimerValue
// -----------------------------------------------------------------------------
//    
void CSIPIetfProfileContext::InitializeRetryTimerValue()
    {
    iRetryTimerUse = 0;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::ConnectionStateChangedImpl
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::ConnectionStateChangedImpl(
    CSIPConnection::TState /*aState*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::DeregisterL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::DeregisterL()
    {
    PROFILE_DEBUG4("CSIPIetfProfileContext::DeregisterL", iProfileId\
        , iCurrentState-&gt;Name())
    iCurrentState-&gt;DeregisterL(*this);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::UpdateL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::UpdateL(
    CSIPConcreteProfile&amp; aNewProfile)
    {
    PROFILE_DEBUG4("CSIPIetfProfileContext::UpdateL", iProfileId\
        , iCurrentState-&gt;Name())
    iCurrentState-&gt;UpdateL(*this, aNewProfile);
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::IncomingResponse()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfProfileContext::IncomingResponse(
    CSIPClientTransaction&amp; aTransaction,
    CSIPRegistrationBinding&amp; aRegistration,
    TBool&amp; aHandled)
    {
    if (iClientTx &amp;&amp; iRegistration &amp;&amp; 
        aTransaction==*iClientTx &amp;&amp; aRegistration==*iRegistration)
        {
        PROFILE_DEBUG3("SIPIetfProfileContext::IncomingResponse", iProfileId)
        aHandled = ETrue;
        const CSIPResponseElements* response = aTransaction.ResponseElements();
        if (response)
            {
            TUint responseCode = response-&gt;StatusCode();
            if (responseCode &gt;= K300MultipleChoices)
                {
                PROFILE_DEBUG1("IETFProfileContext: registration failed")
                RetryPossible(responseCode);
                }
            else
                {
                if (responseCode &gt;= K200Ok)
                    {
                    PROFILE_DEBUG1("IETFProfileContext: registration complete")
                    iRetryCounter = 0;
                    iRetryCounterSum = 0;
                    Received2XXRegisterResponse();
                    }
                }
            }
        iCurrentState-&gt;ResponseReceived(*this, aTransaction);
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::RandomPercent()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TUint CSIPIetfProfileContext::RandomPercent()
    {
    const TInt rand = Math::Rand(iRandomSeed);
    TInt result = 0;
    result = KMaxRandomLimit + (rand%KMaxRandomLimit);
    return result;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::DelayTime()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TUint CSIPIetfProfileContext::DelayTime()
    {
    PROFILE_DEBUG1("CSIPIetfProfileContext::DelayTime")
    TReal res;
    iRetryCounter++;
    iRetryCounterSum++;
    Math::Pow(res,KWaitTimeCoefficient,iRetryCounter);
    TUint respond = res;
    TUint waitTime = KBaseTimeInSec*respond;
    if (waitTime &gt; 1800)
        {
        waitTime = 1800;
        }
    return ((waitTime*RandomPercent())/KRandomDivider);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::RetryTimerInUse()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileContext::RetryTimerInUse()
    {
    return iRetryTimerUse;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::IsAddressSIPSURIL()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileContext::IsAddressSIPSURIL(const TDesC8&amp; aValue) const
    {
    __ASSERT_ALWAYS (aValue.Length() &gt; 0, User::Leave(KErrArgument));
    TUriParser8 uriParser;
    User::LeaveIfError(uriParser.Parse(aValue));
    TPtrC8 sips(SIPStrings::StringF(SipStrConsts::ESips).DesC());
    return (uriParser.Extract(EUriScheme).CompareF(sips) == 0);
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::SetAddressToSIPSURIL()
// -----------------------------------------------------------------------------
//
HBufC8* CSIPIetfProfileContext::SetAddressToSIPSURIL(const TDesC8&amp; aValue)
    {
    TUriParser8 uriParser;
    User::LeaveIfError(uriParser.Parse(aValue));
    CUri8* uri = CUri8::NewLC(uriParser);    
    uri-&gt;SetComponentL(
        SIPStrings::StringF(SipStrConsts::ESips).DesC(),EUriScheme);
    HBufC8* value = uri-&gt;Uri().UriDes().AllocL();
    CleanupStack::PopAndDestroy(uri);
    return value;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::SetTlsToSecurityClientL()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileContext::SetTlsToSecurityClientL()
    {
    TBool tlsSet = EFalse;
    if(!IsAddressSIPSURIL(iProfile-&gt;AOR()) &amp;&amp; 
       iProfile-&gt;IsSecurityNegotiationEnabled())
        {
        const TDesC8&amp; proxyAddr = ProxyAddressL();
        if (proxyAddr.Length() &gt; 0)
            {
            if(IsConfiguredOutboundProxySIPURIL(proxyAddr)|| 
               IsDynamicNumericIPAddress(proxyAddr))
                {
                tlsSet = ETrue;
                }
            }
        }
    return tlsSet;
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::IsDynamicNumericIPAddress()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileContext::IsDynamicNumericIPAddress( const TDesC8&amp; aValue )
    {
    return ( IsProxyResolvingEnabled() &amp;&amp; 
         !( UriUtils::HostType( aValue ) == UriUtils::ETextHost ) );
    }    

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::IsConfiguredOutboundProxySIPURIL()
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfProfileContext::IsConfiguredOutboundProxySIPURIL( const TDesC8&amp; aValue )
    {
    return ( !IsProxyResolvingEnabled() &amp;&amp; !IsAddressSIPSURIL(aValue) );
    }    

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::CreateMsgElementsForUpdateLC
// add SIP headers to REGISTER request
// -----------------------------------------------------------------------------
//
CSIPMessageElements* CSIPIetfProfileContext::CreateMsgElementsForUpdateLC(
    CSIPConcreteProfile&amp; aProfile)
    {
    CSIPMessageElements* elements = CSIPMessageElements::NewLC();
    
    RPointerArray&lt;CSIPHeaderBase&gt; headers;
    CSIPHeaderBase::PushLC(&amp;headers);

    TInt sipHeaderCount = aProfile.SIPHeaders().MdcaCount();
    for (TInt i=0; i &lt; sipHeaderCount; i++)
        {
        TPtrC8 headerDes(aProfile.SIPHeaders().MdcaPoint(i));
        CSIPHeaderBase* header = SIPMessageBuilder::CreateHeaderLC(headerDes);
        headers.AppendL(header);
        CleanupStack::Pop(header);
        }   
        
    elements-&gt;SetUserHeadersL(headers); // An empty array is also allowed
    CleanupStack::Pop(1); // headers
        
    return elements;
    }

// -----------------------------------------------------------------------------
// CSIPIetfProfileContext::TransportProtocol
// -----------------------------------------------------------------------------
//
RStringF CSIPIetfProfileContext::TransportProtocol(const CUri8&amp; aUri) const
    {
    RStringF transport(SIPStrings::StringF(SipStrConsts::EEmpty));
    if (aUri.Uri().Extract(EUriPath).FindF(KTransportUdpParam) &gt;= 0)
        {
        transport = SIPStrings::StringF(SipStrConsts::EUdp); 
        }
    if (aUri.Uri().Extract(EUriPath).FindF(KTransportTcpParam) &gt;= 0)
        {
        transport = SIPStrings::StringF(SipStrConsts::ETcp);
        }
    return transport;
    }
</pre>
 <p><strong>Sipietfconnectioncontext.cpp</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-1C1A7C44-3DB2-5800-94B0-4CB452AE2A8E"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-1C1A7C44-3DB2-5800-94B0-4CB452AE2A8E"><!-- --></a>//Sipietfconnectioncontext.cpp


// INCLUDE FILES

#include    "sipietfconnectioncontext.h"
#include    "sipmessageelements.h"
#include    "sipregistrationbinding.h"
#include    "sipconnection.h"
#include    "sipclienttransaction.h"
#include    "siprefresh.h"
#include    "sipietfprofilecontext.h"
#include    "sipprofileagent.h"
#include    "sipconcreteprofile.h"
#include    "SipProfileLog.h"
#include    "CSIPProxyResolver.h"
#include    "siperr.h"
#include    "sipresponseelements.h"


// ============================ MEMBER FUNCTIONS ===============================

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::CSIPIetfConnectionContext
// C++ default constructor can NOT contain any code, that
// might leave.
// -----------------------------------------------------------------------------
//
CSIPIetfConnectionContext::CSIPIetfConnectionContext()
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::~CSIPIetfConnectionContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfConnectionContext::~CSIPIetfConnectionContext()
    {
    iContexts.ResetAndDestroy();

    delete iProxyResolver;
    delete iConnection;

    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::NewLC
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfConnectionContext* CSIPIetfConnectionContext::NewLC()
    {
    CSIPIetfConnectionContext* self =
        new (ELeave) CSIPIetfConnectionContext();
    CleanupStack::PushL(self);
    self-&gt;ConstructL();
    return self;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::NewL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfConnectionContext* CSIPIetfConnectionContext::NewL()
    {
    CSIPIetfConnectionContext* self = 
        CSIPIetfConnectionContext::NewLC();
    CleanupStack::Pop();
    return self;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::SetConnection
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::SetConnection(CSIPConnection* aConnection)
    {
    iConnection = aConnection;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::Connection
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPConnection* CSIPIetfConnectionContext::Connection()
    {
    return iConnection;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IsIdle
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfConnectionContext::IsIdle() const
    {
    return (iContexts.Count()==0);
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::FindContext
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
CSIPIetfProfileContext* 
    CSIPIetfConnectionContext::FindContext(TUint32 aProfileId)
    {
    CSIPIetfProfileContext* context = 0;
    TBool found = EFalse;
    for (TInt i=0; i&lt;iContexts.Count() &amp;&amp; !found; i++)
        {
        if (iContexts[i]-&gt;Profile() &amp;&amp; iContexts[i]-&gt;Profile()-&gt;Id() == aProfileId)
            {
            context = iContexts[i];
            found = ETrue;
            }
        }
    return context;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::AddProfileContextL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void 
CSIPIetfConnectionContext::AddProfileContextL(CSIPIetfProfileContext* aContext)
    {
    __ASSERT_DEBUG(aContext-&gt;Connection().IapId()==iConnection-&gt;IapId(),
                                                             User::Invariant());
    User::LeaveIfError(iContexts.Append(aContext));
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::CleanIdleContexts
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::CleanIdleContexts()
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::CleanIdleContexts")
    CSIPIetfProfileContext* context = 0;
    for (TInt i= iContexts.Count()-1; i &gt;= 0;i--)
        {
        PROFILE_DEBUG3("CSIPIetfConnectionContext::CleanIdleContexts iContexts.Count() &gt; 0 i=",i)
        if (iContexts[i]-&gt;CurrentState() == MSIPProfileContext::EInit &amp;&amp;
            iContexts[i]-&gt;IsIdle())
            {
            PROFILE_DEBUG1("CSIPIetfConnectionContext::CleanIdleContexts, ProfileContext removed")
            context = iContexts[i];
            iContexts.Remove(i);
            delete context;
            context = NULL;    
            }
        }
    iContexts.Compress();
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::SetCredentials
// -----------------------------------------------------------------------------
//
TBool CSIPIetfConnectionContext::SetCredentials(
    const CSIPClientTransaction&amp; aTransaction,
    CSIPHttpDigest&amp; aDigest)
    {
    TBool found = EFalse;
    for (TInt i=0; i &lt; iContexts.Count() &amp;&amp; !found; i++)
        {
        found = iContexts[i]-&gt;SetCredentials(aTransaction,aDigest);
        }
    return found;   
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::SetCredentials
// -----------------------------------------------------------------------------
//
TBool CSIPIetfConnectionContext::SetCredentials(
    const CSIPRefresh&amp; aRefresh,
    CSIPHttpDigest&amp; aDigest)
    {
    TBool found = EFalse;
    for (TInt i=0; i &lt; iContexts.Count() &amp;&amp; !found; i++)
        {
        found = iContexts[i]-&gt;SetCredentials(aRefresh,aDigest);
        }
    return found;    
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ResolveL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ResolveL()
    {
    CleanProxyResolving();
    ResolveProxyL();
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ResolveProxyL
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ResolveProxyL()
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::ResolveProxyL")
    if (iProxyResolveRequestId == 0)
        {
        if (iProxyResolver == 0)
            {
            iProxyResolver = CSIPProxyResolver::NewL();
            }

        if (iConnection-&gt;State() == CSIPConnection::EActive)
            {
            PROFILE_DEBUG1("CSIPIetfConnectionContext::ResolveProxyL, resolving")
            iProxyResolver-&gt;ResolveProxyL(
                iProxyResolveRequestId, iConnection-&gt;IapId(), *this);
            }
        }
    PROFILE_DEBUG1("CSIPIetfConnectionContext::ResolveProxyL, exit")
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::CleanProxyResolving
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::CleanProxyResolving()
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::CleanProxyResolving")
    if(iProxyResolveRequestId)
        {
        iProxyResolver-&gt;Cancel(iProxyResolveRequestId);
        iProxyResolveRequestId = 0;
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ConnectionStateChanged
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ConnectionStateChanged (
    CSIPConnection::TState aState)
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::ConnectionStateChanged")
    if (aState == CSIPConnection::EActive)
        {
        PROFILE_DEBUG1("ConnectionStateChanged, Active")
        }
    else if (aState == CSIPConnection::EInactive)
        {
        PROFILE_DEBUG1("ConnectionStateChanged, Inactive")
        CleanProxyResolving();
        }
    else
        {
        PROFILE_DEBUG3("ConnectionStateChanged, state: ", aState)
        //makes pclint happy
        }

    CleanIdleContexts();

    for (TInt i=0; i&lt;iContexts.Count(); i++)
        {
        iContexts[i]-&gt;ConnectionStateChanged(aState);
        }
    } 

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingResponse
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingResponse (
    CSIPClientTransaction&amp; aTransaction,
    CSIPRegistrationBinding&amp; aRegistration)
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::IncomingResponse")
    TBool handled = EFalse;

    CleanIdleContexts();

    for (TInt i=0; i&lt;iContexts.Count() &amp;&amp; !handled; i++)
        {
        const CSIPResponseElements* response = aTransaction.ResponseElements();
        if (response)
            {
            TBool isErrorResponse = (response-&gt;StatusCode() &gt;= 300);
            TInt contextCountBefore = iContexts.Count();
            
            iContexts[i]-&gt;IncomingResponse(aTransaction, aRegistration, handled);
            
            TBool contextRemoved = (iContexts.Count() != contextCountBefore);    
            if (handled &amp;&amp; !contextRemoved &amp;&amp; isErrorResponse)
                {
                iContexts[i]-&gt;RetryRegistration();
                }
            }
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt aError,
    CSIPClientTransaction&amp; aTransaction,
    CSIPRegistrationBinding&amp; aRegistration)
    {
    PROFILE_DEBUG3("CSIPIetfConnectionContext::ErrorOccured", aError)
    TBool handled = EFalse;

    CleanIdleContexts();

    for (TInt i=0; i&lt;iContexts.Count() &amp;&amp; !handled; i++)
        {
        iContexts[i]-&gt;ErrorOccured(aError, aTransaction, aRegistration, handled);
        if (handled &amp;&amp; (iProxyResolveRequestId == 0))
            {
            if ( iContexts[i]-&gt;RetryTimerInUse() )
                {
                iContexts[i]-&gt;RetryDeltaTimer( iContexts[i]-&gt;DelayTime() );
                }
            else
                {
                iContexts[i]-&gt;RetryRegistration();
                }
            }
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt aError,
    CSIPRegistrationBinding&amp; aRegistration)
    {
    PROFILE_DEBUG3("CSIPIetfConnectionContext::ErrorOccured", aError)
    TBool handled = EFalse;

    CleanIdleContexts();

    for (TInt i=0; i&lt;iContexts.Count() &amp;&amp; !handled; i++)
        {
        if (aError == KErrSIPTerminatedWithResponse)
            {
            const CSIPClientTransaction* transaction = 
            iContexts[i]-&gt;Registration()-&gt;SIPRefresh()-&gt;SIPTransaction();
            if (transaction)
                {
                aError = transaction-&gt;ResponseElements()-&gt;StatusCode();
                iContexts[i]-&gt;CSIPProfileContextBase::ErrorOccured(aError,
                                   const_cast&lt;CSIPClientTransaction&amp;&gt; (*transaction),
                                   aRegistration,
                                   handled);
                }
            else
                {
                iContexts[i]-&gt;ErrorOccured(aError, aRegistration, handled);
                }
            }
        else
            {
            iContexts[i]-&gt;ErrorOccured(aError, aRegistration, handled);
            }
            
        if (handled &amp;&amp; (iProxyResolveRequestId == 0))
            {
            if ( iContexts[i]-&gt;RetryTimerInUse() )
                {
                iContexts[i]-&gt;RetryDeltaTimer( iContexts[i]-&gt;DelayTime() );
                }
            else
                {
                iContexts[i]-&gt;RetryRegistration();
                }
            }
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ProxyResolvingRequestComplete
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ProxyResolvingRequestComplete (
    TUint /*aRequestId*/, MDesC8Array* aProxies)
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::ProxyResolvingRequestComplete")
    iProxyResolveRequestId = 0;

    CleanIdleContexts();

    TInt err = KErrNone;
    for (TInt i=0; i&lt;iContexts.Count(); i++)
        {
        TRAP(err, iContexts[i]-&gt;ProxyResolvingRequestCompleteL(*aProxies));
        if (err != KErrNone)
            {
            iContexts[i]-&gt;HandleProxyResolvingError(err);    
            }
        }
    delete aProxies;
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ProxyResolvingRequestFailed
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ProxyResolvingRequestFailed (
    TUint /*aRequestId*/, TInt aError)
    {
    PROFILE_DEBUG3("CSIPIetfConnectionContext::\
        ProxyResolvingRequestFailed", aError)
    CleanIdleContexts();
    iProxyResolveRequestId = 0;

    for (TInt i=0; i&lt;iContexts.Count(); i++)
        {
        iContexts[i]-&gt;ProxyResolvingRequestFailed(aError);
        }
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ConstructL
// Symbian 2nd phase constructor can leave.
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ConstructL()
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt /*aError*/,
    CSIPTransactionBase&amp; /*aTransaction*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingRequest
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingRequest (
    CSIPServerTransaction* /*aTransaction*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingRequest
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingRequest (
    CSIPServerTransaction* /*aTransaction*/,
    CSIPDialog&amp; /*aDialog*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingResponse
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingResponse (
    CSIPClientTransaction&amp; /*aTransaction*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingResponse
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingResponse (
    CSIPClientTransaction&amp; /*aTransaction*/,
    CSIPDialogAssocBase&amp; /*aDialogAssoc*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::IncomingResponse
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::IncomingResponse (
    CSIPClientTransaction&amp; /*aTransaction*/,
    CSIPInviteDialogAssoc* /*aDialogAssoc*/)
    {
    }


// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt /*aError*/,
    CSIPDialogAssocBase&amp; /*aDialogAssoc*/)
    {
    }
// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt /*aError*/,
    CSIPTransactionBase&amp; /*aTransaction*/,
    CSIPDialogAssocBase&amp; /*aDialogAssoc*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::ErrorOccured
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::ErrorOccured (
    TInt /*aError*/,
    CSIPRefresh&amp; /*aRefresh*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::InviteCompleted
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::InviteCompleted (
    CSIPClientTransaction&amp; /*aTransaction*/)
    {
    }
    
// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::InviteCanceled
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
void CSIPIetfConnectionContext::InviteCanceled (CSIPServerTransaction&amp; /*aTransaction*/)
    {
    }

// -----------------------------------------------------------------------------
// CSIPIetfConnectionContext::AddIntoQueue
// (other items were commented in a header).
// -----------------------------------------------------------------------------
//
TBool CSIPIetfConnectionContext::AddIntoQueue( const TDesC8&amp; aValue )
    {
    PROFILE_DEBUG1("CSIPIetfConnectionContext::AddIntoQue")
    TBool result = EFalse;
    for (TInt i=0; i&lt;iContexts.Count() &amp;&amp; !result; i++)
        {
        result = iContexts[i]-&gt;AddIntoQueue( aValue );
        }
    return result;
    }
</pre>
 <p><strong>implementationproxy.cpp</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4FD20A33-9841-5912-BA5A-27D752CFA188"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-4FD20A33-9841-5912-BA5A-27D752CFA188"><!-- --></a>//implementationproxy.cpp

#include "sipietfprofileagent.h"
#include &lt;implementationproxy.h&gt;

// Disabled PC-Lint warning for "suspicious typecast" caused by Symbian's
// ECom declarations
/*lint -e611 */


const TImplementationProxy ImplementationTable[] =
    {
    //Implementation UID and pointer to instantiation method
    IMPLEMENTATION_PROXY_ENTRY( 0x101F413A, CSIPIetfProfileAgent::NewL )
    };

EXPORT_C const TImplementationProxy* ImplementationGroupProxy(TInt&amp; aTableCount)
    {
    aTableCount = sizeof(ImplementationTable) / sizeof(TImplementationProxy);

    return ImplementationTable;
    }
</pre>
 <p><strong>101F4139.rss</strong> </p>
 <pre class="codeblock" id="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-B78EFCF4-F43D-52B1-9082-194C74585253"><a name="GUID-E9AF73E8-DF31-5C5E-889E-96CCD4C4A46B__GUID-B78EFCF4-F43D-52B1-9082-194C74585253"><!-- --></a>// 101F4139.rss

#include "registryinfov2.rh"

RESOURCE REGISTRY_INFO theInfo
{
resource_format_version = RESOURCE_FORMAT_VERSION_2;
dll_uid = 0x101F4139;
interfaces = 
    {
    INTERFACE_INFO
        {
        interface_uid = 0x101F4136;
        implementations = 
            {
            IMPLEMENTATION_INFO
                {
                implementation_uid = 0x101F413A;
                version_no = 1;
                display_name = "standard IETF profile agent";
                default_data = "0_IETF";
                }            
            };
        }
    };
}
</pre>
 </div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-BDD99F37-FD44-56FF-A849-015FCEE8F2D9.html">SIP Profile Agent API</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>