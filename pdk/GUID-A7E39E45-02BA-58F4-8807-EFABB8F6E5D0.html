<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Processing pen events"/>
<meta name="abstract" content="This topic describes various events processed by Pen or Mouse."/>
<meta name="description" content="This topic describes various events processed by Pen or Mouse."/>
<meta name="DC.Relation" scheme="URI" content="GUID-68A55CD5-EF01-5DE2-8119-EFA39589960F.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-94005A46-B4C6-4A30-A8E8-1B9C2D583D50.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-E079315A-E5B6-4D33-B7E3-88697A3F11A4.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-0C6CCACF-84B2-5715-BCF3-12330E6F05D4.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-68A55CD5-EF01-5DE2-8119-EFA39589960F.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Processing pen events</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2561792 id2839629 id2839186 id2839196 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-94005A46-B4C6-4A30-A8E8-1B9C2D583D50.html">Classic UI Guide</a> &gt; <a href="GUID-E079315A-E5B6-4D33-B7E3-88697A3F11A4.html">Control and animation framework</a> &gt; <a href="GUID-0C6CCACF-84B2-5715-BCF3-12330E6F05D4.html" title="This section explains Front End Processor (FEP), and its implementations and events.">Using Front End Processor (FEPBASE)</a> &gt; <a href="GUID-68A55CD5-EF01-5DE2-8119-EFA39589960F.html">How to Write a FEP</a> &gt; </div>
<h1 class="topictitle1">Processing
pen events</h1>
<div><p>This topic describes various events processed by Pen or Mouse.</p>

<div class="section" id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-FB1CCFC8-F70A-4D6E-BF27-3652413359AE"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-FB1CCFC8-F70A-4D6E-BF27-3652413359AE"><!-- --></a><h2 class="sectiontitle">Simple drag
events</h2> <p>In order for the FEP control to receive drag events occurring
in its window, all that is needed is to call <samp class="codeph">EnableDragEvents()</samp> in
the control’s construction routine. Having done that, the control will receive
drag events as calls to its <samp class="codeph">HandlePointerEventL()</samp> virtual
function. The <samp class="codeph">iType</samp> member of <samp class="codeph">HandlePointerEventL()</samp> ’s <samp class="codeph">aPointerEvent</samp> parameter
is set to <samp class="codeph">TPointerEvent::EDrag</samp> for drag events. </p>
 <p>This
method makes heavy use of IPC (inter-process communication) as the user drags
the mouse/pen around the FEP control’s window, which means that the FEP does
not get drag events at optimum frequency. This may be problematic for something
like handwriting recognition software. If there is a requirement to follow
the path traced by the mouse/pen as closely as possible, another method can
be used, namely buffered drag events. </p>
 </div>

<div class="section" id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-739BD481-1EAF-42B3-B0F0-8C50D01CE488"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-739BD481-1EAF-42B3-B0F0-8C50D01CE488"><!-- --></a><h2 class="sectiontitle">Buffered drag
events</h2> <p>The advantage of buffered drag events over simple drag events
is that the window server client can receive multiple mouse/pen positions
in a single event, which reduces the IPC overhead. To enable this, the following
code needs to be called in the FEP control’s construction routine: </p>
 <pre class="codeblock" id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-3247B04E-05FD-534E-8F8D-C15DE2FEA33C"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-3247B04E-05FD-534E-8F8D-C15DE2FEA33C"><!-- --></a>User::LeaveIfError(DrawableWindow()-&gt;AllocPointerMoveBuffer(ENumberOfPointsInBuffer, 0));</pre>
 <p>This assumes that <samp class="codeph">ENumberOfPointsInBuffer</samp> has been defined
elsewhere; TFEP2Plugin sets this constant to 32. The control
then receives drag events as calls to its <samp class="codeph">HandlePointerBufferReadyL()</samp> virtual
function, rather than as calls to <samp class="codeph">HandlePointerEventL()</samp>.
To retrieve these drag events, include the following code at the start of
the FEP control’s <samp class="codeph">HandlePointerBufferReadyL()</samp> function: </p>
 <pre class="codeblock" id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-18B4F1EB-7090-5C6C-9EB4-98F6CF37FA88"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-18B4F1EB-7090-5C6C-9EB4-98F6CF37FA88"><!-- --></a>TPoint arrayOfPoints[ENumberOfPointsInBuffer];
TPtr8 bufferOfPoints(REINTERPRET_CAST(TUint8*, arrayOfPoints), 0, ENumberOfPointsInBuffer*sizeof(TPoint));
User::LeaveIfError(DrawableWindow()-&gt;RetrievePointerMoveBuffer(bufferOfPoints));
const TInt numberOfPointsInBuffer=bufferOfPoints.Length()/sizeof(TPoint);</pre>
 <p>Having
done that, <samp class="codeph">numberOfPointsInBuffer</samp> of <samp class="codeph">arrayOfPoints</samp> can
be used for whatever purpose the FEP requires, for example handwriting recognition.
Note that <samp class="codeph">AllocPointerMoveBuffer()</samp> ’s counterpart <samp class="codeph">FreePointerMoveBuffer()</samp> does
not need to be called in the FEP control’s destructor as this happens automatically
when the control’s window is destroyed. </p>
</div>

<div class="section" id="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-9E66280C-65AE-4AB1-9F00-65FBE6CF218D"><a name="GUID-A7E39E45-02BA-58F4-8807-EFABB8F6E5D0__GUID-9E66280C-65AE-4AB1-9F00-65FBE6CF218D"><!-- --></a><h2 class="sectiontitle">Intercepting
pen events anywhere on the screen</h2> <p>In order to intercept mouse/pen
events anywhere on the screen it is necessary to write a plugin into the window
server (WSERV). This is in addition to the FEP plugin which plugs into the
FEP architecture. TFEP2plugin provides a working example of this (TFEP2be).
The details of how to write a window server plugin DLL are beyond the scope
of this document because the APIs involved belong to the window server. See <a href="GUID-029C644B-BE0F-37C6-95E2-D27F974E6AD3.html"><span class="apiname">CAnim</span></a> and <samp class="codeph">CAnimDll</samp> in
the SDK for information on this. The way mouse/pen events can be intercepted
is by returning <samp class="codeph">ETrue</samp> from the function overriding <samp class="codeph">MEventHandler::OfferRawEvent()</samp> (<a href="GUID-029C644B-BE0F-37C6-95E2-D27F974E6AD3.html"><span class="apiname">CAnim</span></a> derives
from <a href="GUID-F1B47E38-4585-3903-93C7-0BCB075465AA.html"><span class="apiname">MEventHandler</span></a>). Events which are handled in this way
will not be sent to the relevant window server client, in other words, the
client who would otherwise have received this event. </p>
 <p>The sprite feature
of the window server (<a href="GUID-75C09150-E93B-323D-AFBF-E42C7BD78229.html"><span class="apiname">RWsSprite</span></a>, defined in <span class="filepath">epoc32\include\W32STD.H</span>)
can be used to display to the user the path on the screen being traced out
by their mouse/pen movements. However, care should be taken when using sprites
for this purpose. Sprites use bitmaps, which in this context would need to
be the size of the screen. Because each running application has its own FEP,
which would have its own sprite, which in turn would have its own screen-sized
bitmap, it becomes apparent that some optimization must be done to avoid huge
amounts of memory being consumed. TFEP2Plugin solves this problem by using
a single bitmap shared between each sprite. It uses the 4 byte thread-local
storage of the window server plugin DLL to store the identifier of this bitmap.
The code which constructs the sprite is protected by a mutex (<a href="GUID-C0FEA3A0-7DD3-3B87-A919-CB973BC05766.html"><span class="apiname">RMutex</span></a>,
defined in <span class="filepath">epoc32\include\E32STD.H</span>) as it tests to see
if the bitmap to be used by the sprite has already been created by a FEP running
the same code in another thread. If it has then it merely calls <samp class="codeph">CFbsBitmap::Duplicate()</samp> which
simply increments the existing bitmap’s reference count, thus only one large
bitmap is created rather than one per running application. </p>
 <p>Intercepting
mouse/pen events anywhere on the screen is likely to be most useful to handwriting-interpreting
FEPs. Given that using this feature involves two polymorphic DLLs (plugging
into different frameworks) running in two separate threads in separate processes,
there is a choice regarding where the bulk of the FEP’s processing is done.
The advantage of the processing being done outside of the window server process
(in other words, in the FEP architecture plugin) is that bugs in the processing
code (for instance crashing or hanging) do not affect the whole machine. The
advantage of the processing being done inside the window server process (in
other words, in the window server plugin) is that the long lists of screen
positions (tracing out the path of where the user has dragged the mouse/pen)
do not need to be communicated between processes. </p>
</div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-68A55CD5-EF01-5DE2-8119-EFA39589960F.html">How to Write a FEP</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>