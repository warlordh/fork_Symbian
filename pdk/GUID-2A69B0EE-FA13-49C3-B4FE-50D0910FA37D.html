<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="task"/>
<meta name="DC.Title" content="Processing Key Stream"/>
<meta name="abstract" content="The CKeyStreamDecoder class provides an interface for initializing key stream decoders and process a key stream."/>
<meta name="description" content="The CKeyStreamDecoder class provides an interface for initializing key stream decoders and process a key stream."/>
<meta name="DC.Relation" scheme="URI" content="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-315452C2-A1E2-5888-A694-6D2DE73A3F5E.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-E6C91CF2-A616-5E52-8BB2-630C42C8D540.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-AD61E913-9720-5F6B-8386-680384165E87.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-4AAE6CC7-7F0B-51B7-8F6F-7E538841DF41.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Processing Key Stream</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2858558 id2858692 id2858890 id2858933 id2858942 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-315452C2-A1E2-5888-A694-6D2DE73A3F5E.html">OS Security Guide</a> &gt; <a href="GUID-E6C91CF2-A616-5E52-8BB2-630C42C8D540.html">Content Management</a> &gt; <a href="GUID-AD61E913-9720-5F6B-8386-680384165E87.html">CAF Streaming Support</a> &gt; <a href="GUID-4AAE6CC7-7F0B-51B7-8F6F-7E538841DF41.html">CAF Streaming Support Tutorials</a> &gt; <a href="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html">Using streaming CAF</a> &gt; </div>
<h1 class="topictitle1">Processing
Key Stream</h1>
<div><p>The <samp class="codeph">CKeyStreamDecoder</samp> class provides an interface
for initializing key stream decoders and process a key stream.</p>

<div class="section" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-BFEED1F1-D00C-4E4A-B14E-8F60842A5F13"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-BFEED1F1-D00C-4E4A-B14E-8F60842A5F13"><!-- --></a>       <p>Follow the steps below to process a Key stream:</p>
   
 </div>

<a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-4DD07DEC-6017-4237-BE46-1D69E5FBD744-GENID-1-12-1-26-1-1-6-1-6-1-5-1-3-1-4-1-3-2"><!-- --></a><ol id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-4DD07DEC-6017-4237-BE46-1D69E5FBD744-GENID-1-12-1-26-1-1-6-1-6-1-5-1-3-1-4-1-3-2"><li class="stepexpand" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-9A69E5AD-E938-4092-A8C2-CB65C37C8962-GENID-1-12-1-26-1-1-6-1-6-1-5-1-3-1-4-1-3-2-1"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-9A69E5AD-E938-4092-A8C2-CB65C37C8962-GENID-1-12-1-26-1-1-6-1-6-1-5-1-3-1-4-1-3-2-1"><!-- --></a><span>Initialize a key
stream decoder using <a href="GUID-EE67D14D-1011-3B27-ADEC-C6C192339903.html#GUID-EE67D14D-1011-3B27-ADEC-C6C192339903__GUID-F8F59778-6554-35A0-A2AD-DD689A89664D"><span class="apiname">CKeyStreamDecoder::NewLC()</span></a> to launch
a streaming agent. </span>
            <p>When a key stream decoder is initialized, a streaming
agent that can handle the requested stream data is identified and launched.
Get the required parameters as input for integrating with the with Session
Description Protocol (SDP) definition.</p>
         
</li>
<li class="stepexpand" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-FC110D39-02A7-4E47-8766-3C98619DA560"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-FC110D39-02A7-4E47-8766-3C98619DA560"><!-- --></a><span>Query attributes
from the server using <a href="GUID-EE67D14D-1011-3B27-ADEC-C6C192339903.html#GUID-EE67D14D-1011-3B27-ADEC-C6C192339903__GUID-9F2F3999-FC78-3489-9A6A-FFE01F73E608"><span class="apiname">CKeyStreamDecoder::GetStringAttributeL()</span></a> and <a href="GUID-EE67D14D-1011-3B27-ADEC-C6C192339903.html#GUID-EE67D14D-1011-3B27-ADEC-C6C192339903__GUID-4E8A180B-EF34-3714-A58B-4CC7906D4BA3"><span class="apiname">CKeyStreamDecoder::GetAttributeL()</span></a>. </span>
 <p>These methods provides information about a broadcaster or content
provider and recording right indicating whether a stream can be recorded.</p>

</li>
<li class="stepexpand" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-81A63AB2-E777-43F9-AA61-40BA91253484"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-81A63AB2-E777-43F9-AA61-40BA91253484"><!-- --></a><span>Record the stream
data using <a href="GUID-EE67D14D-1011-3B27-ADEC-C6C192339903.html#GUID-EE67D14D-1011-3B27-ADEC-C6C192339903__GUID-676470BD-41BC-3958-874D-40161B3895E1"><span class="apiname">CKeyStreamDecoder::CreateImportSessionLC()</span></a> to
check for post-acquisition rights. </span>
 <p>If the rights object does not match with the recording rights, the
request fails and returns an error. </p>

</li>
</ol>

<div class="example"><p><strong>Initializing key stream decoder</strong></p>
<p>The following code
segment shows initializing a key stream decoder and querying attributes from
the server. </p>
<p> <strong>Note</strong>: The key stream decoder needs to remain active,
to process a key stream. </p>
<pre class="codeblock" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-45178C59-4E22-5D1F-BAFF-61F7AED55D48"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-45178C59-4E22-5D1F-BAFF-61F7AED55D48"><!-- --></a>
/* In this code sample, a key stream decoder is created to decode a key stream which 
   is protected by IPSec. Create a protected stream descriptor for IPSec.
   serverAddr =&gt; source connection address (content distributor in real case). 
   This address can be extracted from the SDP (Session Description Protocol).
   It is assumed that the client has already received this object.
   clientAddr =&gt; target connection address (device in real case).
 
*/

CProtectedStreamDesc *protectedStreamDesc = CIpSecProtectedStreamDesc::NewLC(serverAddr, clientAddr);

/* The relevant media field for the key stream (CSdpMediaField* keyStreamSDPDesc) is 
  extracted from the SDP (CSdpDocument* sdpDocument).
   ......
   Now create the key stream decoder by using the protected stream descriptor, the key stream media 
   field, and the whole SDP object. 
*/

CKeyStreamDecoder *keyStreamDecoder = CKeyStreamDecoder::NewLC(protectedStreamDesc, keyStreamSDPDesc, 
 sdpDocument);
Cleanupstack::PopAndDestroy(protectedStreamDesc);

/*If this section of code is reached, the key stream decoder is initialized correctly. If the user has rights to view the stream, the content 
            will be decrypted.
*/</pre>
<p>The following sequence of events occur in the back-end: </p>
<ul>
<li><p>In case of an authenticated user of the service, the streaming agent
loads the key stream. This creates a key stream decoder object. </p>
</li>

<li><p>The streaming agent starts a new processing task to decrypt the protected
stream data. For example, the key processing task for IPSec is to decrypt
Short Term Key Message (STKM) received as the key stream, and extract the
corresponding cryptographic context. </p>
</li>

</ul>
<div class="note"><span class="notetitle">Note:</span> s<ul>
<li id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-08F29A6F-B8ED-5D19-A8B1-D2F25FDD82E5"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-08F29A6F-B8ED-5D19-A8B1-D2F25FDD82E5"><!-- --></a><p>The key stream object
must be kept alive while receiving the key stream and decrypting the protected
streamed data. </p>
 </li>

<li id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-B6FE0479-9679-536A-ADF7-1C7861E8EE4B"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-B6FE0479-9679-536A-ADF7-1C7861E8EE4B"><!-- --></a><p>If the user is not authenticated,
(for example, no rights for a specific pay-per-view program), cryptographic
context will not be set. </p>
 </li>

</ul>
</div>
<p><strong>Querying for protected stream content</strong></p>
<p>Query the
streaming agent to get information about the protected stream content, using
the created key stream decoder object. </p>
 <p>The following code snippet
shows an example for querying the playability of the content: </p>
 <pre class="codeblock" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-8F515267-8EC1-55E6-B571-C25EFEDB66CC"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-8F515267-8EC1-55E6-B571-C25EFEDB66CC"><!-- --></a>TBool playable = EFalse;
keyStreamDecoder-&gt;GetAttributeL(ECanPlay, playable);

// When the protected key stream receiving has finished or stopped, the key decoder object is destroyed.
Cleanupstack::PopAndDestroy(keyStreamDecoder);</pre>
<p><strong>Recording
protected stream content</strong> </p>
 <p>The following code snippet shows an example
of recording protected streamed content with post-acquisition rights. </p>
 <pre class="codeblock" id="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-17747B2A-4E98-5999-94ED-53225D6717B7"><a name="GUID-2A69B0EE-FA13-49C3-B4FE-50D0910FA37D__GUID-17747B2A-4E98-5999-94ED-53225D6717B7"><!-- --></a>// Generate a protected key stream description for IPSec
CProtectedStreamDesc *protectedStreamDesc = CIpSecProtectedStreamDesc::NewLC(serverAddr, clientAddr);

// Create a key stream decoder 
CKeyStreamDecoder *keyStreamDecoder = CKeyStreamDecoder::NewLC(protectedStreamDesc, keyStreamSDPDesc,
 sdpDocument);

//Check whether the content is recordable
TBool value = EFalse;
keyStreamDecoder-&gt;GetAttributeL(ECanExport, value);
if(!value)
    {
    User::Leave(KErrCANotSupported);
    }

/* Get an import handle to record the protected streamed data in 3GPP video format
   By using the import handle, the streamed content will be recorded as protected together
   with its post-acquisition Rights Object. After importing, the recorded content is reached
   according to the restrictions defined in the post-acquisition Rights Object.
*/
CImportFile* import = keyStreamDecoder-&gt;CreateImportSessionLC(_L8("video/3gpp")); 

TPtr8 decryptedContent;
 do
    {
    
    // Decrypt the protected streamed content and assign to decryptedContent pointer.
    
    import-&gt;WriteData(decryptedContent);
    } while (decryptedContent);

// Import has been completed.
TFileName fileName;
TInt err = import-&gt;WriteDataComplete();
while (err == KErrCANewFileHandleRequired)              
     {
     err = ProvideNewOutputFileL(*import, fileName);
     if(err == KErrNone)
         {
         err = import-&gt;WriteDataComplete();
         }
     }
User::LeaveIfError(err);
</pre>
 </div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html">Using streaming CAF</a></div>
</div>
<div class="relinfo relconcepts"><strong>Related concepts</strong><br/>
<div><a href="GUID-6AEA1BCF-EF19-5F6A-9452-E1149C949727.html">Using Streaming
CAF</a></div>
</div>
</div>   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>