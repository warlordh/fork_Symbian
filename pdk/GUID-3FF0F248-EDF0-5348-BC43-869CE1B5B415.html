<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="task"/>
<meta name="DC.Title" content="Setting Microsoft OS Descriptor"/>
<meta name="abstract" content="This section describes how to set the Microsoft OS Descriptor (MOD) for using Symbian MTP over USB services."/>
<meta name="description" content="This section describes how to set the Microsoft OS Descriptor (MOD) for using Symbian MTP over USB services."/>
<meta name="DC.Relation" scheme="URI" content="GUID-F574AEA9-88AE-55B4-8CF4-CBD7AF402A1A.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-A0D4B6EC-8FA7-5FD9-AE5A-E811D876D585.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-B9709F2F-C53A-5455-B19E-23B9B40101B4.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-7C527EE7-140B-5E52-95FD-DAB1890B7E6D.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-F574AEA9-88AE-55B4-8CF4-CBD7AF402A1A.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-B2F5537B-3F47-5172-8DFA-185CC1CAAD22.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-DE2E64A5-417A-538C-904B-6D498BB55273.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Setting Microsoft OS Descriptor</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2534806 id2535110 id2535170 id2535185 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-A0D4B6EC-8FA7-5FD9-AE5A-E811D876D585.html">Remote Connectivity Guide</a> &gt; <a href="GUID-B9709F2F-C53A-5455-B19E-23B9B40101B4.html">MTP Transports</a> &gt; <a href="GUID-7C527EE7-140B-5E52-95FD-DAB1890B7E6D.html" title="This section describes the MTP USB transport components and how to enable MTP over USB.">MTP USB Transport</a> &gt; <a href="GUID-F574AEA9-88AE-55B4-8CF4-CBD7AF402A1A.html">Enabling MTP over USB Tutorials</a> &gt; </div>
<h1 class="topictitle1">Setting
Microsoft OS Descriptor</h1>
<div><p>This section describes how to set the Microsoft OS Descriptor (MOD)
for using Symbian MTP over USB services. </p>

<div class="p"><p>Before you start, you must: </p>
 <ul>
<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-9A2A0DD6-06B3-5BF9-966F-B2E83C1CB18A"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-9A2A0DD6-06B3-5BF9-966F-B2E83C1CB18A"><!-- --></a><p>Have a general understanding
of the <a href="http://www.microsoft.com" target="_blank">MTP Enhanced
Specification v0.95</a>. </p>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-2E60F217-425C-593C-8D35-D7D82F842D8D"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-2E60F217-425C-593C-8D35-D7D82F842D8D"><!-- --></a><p>Have a general understanding
of the <a href="http://www.usb.org/developers/devclass/" target="_blank">USB
2.0 Specification</a> (particularly Chapter 9.3 which describes the request
types). </p>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-A4BE2E18-013B-5FF9-A126-961EBB73ACDE"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-A4BE2E18-013B-5FF9-A126-961EBB73ACDE"><!-- --></a><p>Understand <a href="http://msdn.microsoft.com/en-us/library/ms790473.aspx" target="_blank">Microsoft-Defined USB Descriptors</a>, <a href="http://www.microsoft.com/whdc/connect/usb/os_desc.mspx" target="_blank">Microsoft OS Descriptors</a> and <a href="http://msdn.microsoft.com/en-us/library/ms790473.aspx" target="_blank">Extended Compat ID OS Feature Descriptor Specification</a> in
detail. </p>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-DDB32234-882D-522C-8D60-9F80FCF7DF31"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-DDB32234-882D-522C-8D60-9F80FCF7DF31"><!-- --></a><p>Understand the <a href="GUID-B2F5537B-3F47-5172-8DFA-185CC1CAAD22.html">Symbian MTP over USB architecture</a>. </p>
 </li>

</ul>
 </div>

<div class="section"><p>The USB Device Working Group does not define the class and sub-class
ID for MTP. To allow a Symbian device to plug into Windows and handle MTP
requests without installing software or requiring user interactions, device
creators must provide Microsoft OS Descriptor (MOD) support in their user
implementations. </p>
 <p>Two MODs must be supplied by the Symbian device:
The OS string descriptor which stores vendor-specific information and the
OS feature descriptor which contains the compatible ID (compat ID) and MTP
sub-compatible ID (sub-compat ID). The compat ID is the class code for MTP.
After getting a valid OS string descriptor, Windows will try to get the compat
ID for MTP. The driver or class for MTP is finally loaded on Windows to handle
MTP requests. </p>
 <p>To enable Symbian MTP over USB, device creators must
implement a MOD solution. The implementation is referred to as user implementation.
The implementation can be built into a user binary such as EXE or DLL. The
user binary must be started up or loaded any time before enabling the MTP
over USB. </p>
 <p>The following tasks must be completed in the user implementation: </p>
 <a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-12B79044-A50F-5C51-A6E3-1B4358683B58"><!-- --></a><ol id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-12B79044-A50F-5C51-A6E3-1B4358683B58">
<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-33C846CF-93A5-582E-A208-00B2B4B8D815"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-33C846CF-93A5-582E-A208-00B2B4B8D815"><!-- --></a><p>Load the USB Logical
Device Driver (LDD) and open an LDD client. </p>
 <p>After the user binary
is loaded, the LDD must be loaded and the LDD client must be opened. The string
OS descriptor can then be written into the LDD in the next step. </p>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-B6FEFA9E-98AC-5AFF-ABE2-50FB8E9BCB25"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-B6FEFA9E-98AC-5AFF-ABE2-50FB8E9BCB25"><!-- --></a><p>Set the OS string descriptor
to the LDD. </p>
 <p>A USB device which supports MOD must contain an OS string
descriptor. Windows sends a request to the device to retrieve the OS string
descriptor from the LDD. </p>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-5776F91A-6279-57F7-B257-2DCA9563B190"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-5776F91A-6279-57F7-B257-2DCA9563B190"><!-- --></a><p>Route device-directed
requests to the user binary. </p>
 <p>In the next step, Windows will send a
control request to the device to get the compat ID OS feature descriptor.
This request is vendor-specific and device-directed and must be handled by
device creators in their user implementation. To enable the USB Stack to route
the request to the user binary, the user implementation must call <samp class="codeph">RDevUsbcClient::SetDeviceControl()</samp>.
Device-directed requests from the PC are all then routed to this instance
of <samp class="codeph">RDevUsbcClient</samp>. </p>
 <div class="fignone" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-FD68DA9C-2175-5B9D-B4A1-8A8B6D0EAEA8"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-FD68DA9C-2175-5B9D-B4A1-8A8B6D0EAEA8"><!-- --></a>
<img src="GUID-1E2DC905-472F-519F-A390-A1189FCB0F9D_d0e638886_href.jpg"/>
</div>
 </li>

<li id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-39D9E728-14DA-58DB-9F3A-C30B23832ECA"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-39D9E728-14DA-58DB-9F3A-C30B23832ECA"><!-- --></a><p>Provide an OS feature
descriptor handler. </p>
 <p>Once a valid OS string descriptor is returned,
Windows sends another control request to get the Microsoft extended compat
ID OS feature descriptor. </p>
 <p>Once the compat ID has been returned to
the PC it can load the right MTP driver and class to handle MTP requests. </p>
 <p>Note:
The string OS descriptor is written into the LDD. The OS feature descriptor
is returned by the user implementation at runtime. </p>
 </li>

</ol>
 <p>For more information about device directed requests and other types
of requests, refer to <a href="http://www.usb.org/developers/devclass/" target="_blank">USB 2.0 Specification Chapter 9.3</a>. For more information
about the OS string descriptor and OS feature descriptor, refer to <a href="http://www.microsoft.com/whdc/connect/usb/os_desc.mspx" target="_blank">Microsoft OS Descriptors</a>. </p>
 </div>

<a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-DA0DA5E7-D1CA-59DA-AAA3-4C6B05E1A0D9"><!-- --></a><ol id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-DA0DA5E7-D1CA-59DA-AAA3-4C6B05E1A0D9"><li class="stepexpand" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-03B9EE7D-F04A-5957-8B68-6319BE685586"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-03B9EE7D-F04A-5957-8B68-6319BE685586"><!-- --></a><span/><br/>
 Load the USB LDD–<span class="filepath">usbc.ldd</span> and open a client of
it. 
 <pre class="codeblock" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-799C6FC1-438A-5B7D-857B-02E58C29E3CB"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-799C6FC1-438A-5B7D-857B-02E58C29E3CB"><!-- --></a>_LIT(KUsbLDDName, "eusbc"); //Name passed to User::LoadLogicalDevice()
_LIT(KUsbLDDFreeName, "Usbc"); //Name passed to User::FreeLogicalDevice()

TInt err = User::LoadLogicalDevice(KUsbLDDName); // Load the USB logical device

if (err != KErrNone &amp;&amp; err != KErrAlreadyExists)
   {
   User::Leave(err);
   }

RDevUsbcClient ldd; //Create a client of the USB logical device

User::LeaveIfError(ldd.Open(0)); //Open the client

</pre>
 
</li>
<li class="stepexpand" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-8C094EE4-5C2D-54F6-A62F-9197B66CC606"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-8C094EE4-5C2D-54F6-A62F-9197B66CC606"><!-- --></a><span/><br/>
 Set the OS string descriptor. 
 OS string descriptor is stored in the USB device driver at the fixed
index of 0xEE. It contains a request number that Windows uses to retrieve
OS feature descriptors. 
 <pre class="codeblock" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-5B8B2191-F298-578F-AB9D-417CE44CA4D3"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-5B8B2191-F298-578F-AB9D-417CE44CA4D3"><!-- --></a>/**
 * MTP OS string decsriptor definitions.
 */
const TUint8 KMTPUsbOSStringIndex(0xEE); //OS string descriptor index
_LIT16(KMTPUsbOSStringSignature, "MSFT100\xAE"); //qwSignature and bMS_VendorCode

// Write the OS string descriptor to the LDD.
User::LeaveIfError(ldd.SetStringDescriptor(KMTPUsbOSStringIndex, KMTPUsbOSStringSignature));

</pre>
 
  <samp class="codeph">qwSignature</samp> and <samp class="codeph">bMS_VendorCode</samp> are
two key fields which must be set. <samp class="codeph">qwSignature</samp> is a Unicode
character array which identifies the descriptor as an OS string descriptor. <samp class="codeph">bMS_VendorCode</samp> is
one byte field whose value is set by the vendor. This value is used by Windows
to request the OS feature descriptor (compat ID and sub-compat ID). 
</li>
<li class="stepexpand" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-6F5FD06E-53FC-556D-AB22-FB5DADBFE60A"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-6F5FD06E-53FC-556D-AB22-FB5DADBFE60A"><!-- --></a><span/><br/>
 Route device-directed requests to the user binary. 
 The user implementation must include the following to enable the USB
Stack to route the device directed requests to the user binary. 
 <pre class="codeblock" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-44E8D26E-0D0F-5643-8483-5E1F3CA4C7F8"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-44E8D26E-0D0F-5643-8483-5E1F3CA4C7F8"><!-- --></a>User::LeaveIfError(ldd.SetDeviceControl()); 
</pre>
 
  Note: Only one instance of RDevUsbcClient can hold the device control
at any given time. 
</li>
<li class="stepexpand" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-34F47BD0-9489-5534-A207-ABCC9D689B1F"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-34F47BD0-9489-5534-A207-ABCC9D689B1F"><!-- --></a><span/><br/>
 Provide the OS feature descriptor handler. 
 Once a valid OS string descriptor has been returned, Windows retrieves
the OS feature descriptor which it uses to load the appropriate USB driver.
In this case, the OS feature descriptor contains the MTP compat ID and MTP
sub-compat ID. 
 <pre class="codeblock" id="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-A1CEEFCB-CEFE-5A55-9B86-9B6833020B9B"><a name="GUID-3FF0F248-EDF0-5348-BC43-869CE1B5B415__GUID-A1CEEFCB-CEFE-5A55-9B86-9B6833020B9B"><!-- --></a>// KMsOSFeatureDescriptor 
_LIT8(KMsOSFeatureDescriptor, "\x28\x00\x00\x00\x00\x01\x04\x00\x01\x00\x00\x00\x00\x00\x00\x00" \
//dwLength     |  bcdVersion | wIndex | bCount | Reserved      
//4 characters |  2 chars    |  2     | 1      | 7

"\x00\x01\x4D\x54\x50\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00");
// bFirstInterfaceNumber | bInterfaceCount |compatibleID | subCompatibleID | Reserved
// 1                     | 1               | 8           | 8               | 6

const TInt KMODHeaderSize   = 0x10; //The first 16 characters of the feature descriptor
const TInt KMODFunctionSize = 0x28;  

TRequestStatus status;

//aRequest is a structure for requests defined by a device creator
//wLength is the field which specifies the length of the data to be transferred
TInt length(aRequest.wLength); 

if (length == KMODHeaderSize)
   {
   // The request is for the header. Return just the header
   ldd.Write(status, EEndpoint0, KMsOSFeatureDescriptor().Left(KMODHeaderSize), KMODHeaderSize, ETrue);
   }
else if (length == KMODFunctionSize)
   {
   ldd.Write(status, EEndpoint0, KMsOSFeatureDescriptor(),KMODFunctionSize, ETrue);
   }</pre>
 
</li>
</ol>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-F574AEA9-88AE-55B4-8CF4-CBD7AF402A1A.html">Enabling MTP over USB Tutorials</a></div>
</div>
<div class="relinfo relconcepts"><strong>Related concepts</strong><br/>
<div><a href="GUID-B2F5537B-3F47-5172-8DFA-185CC1CAAD22.html">MTP USB Transport
Overview</a></div>
</div>
<div class="relinfo"><strong>Related information</strong><br/>
<div><a href="GUID-DE2E64A5-417A-538C-904B-6D498BB55273.html">Symbian USB
Manager</a></div>
</div>
</div>   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>